<p-dialog
  header="Create Source System"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '60vw', height: '90vh' }"
  (onHide)="cancel()"
>
  <!-- Stepper -->
  <p-steps [model]="steps" [activeIndex]="currentStep" class="mb-4"></p-steps>

  <!-- Step 1: Metadata Form (REST | AAS) -->
  <ng-container *ngIf="currentStep === 0">
    <form [formGroup]="form" class="p-fluid">
      <div class="p-field">
        <label for="name">Name*</label>
        <input id="name" type="text" pInputText formControlName="name"/>
      </div>
      <div class="p-field">
        <label for="apiUrl">Base URL*</label>
        <input id="apiUrl" type="text" pInputText formControlName="apiUrl"/>
      </div>
      <!-- AAS-only field -->
      <div class="p-field" *ngIf="isAas()">
        <label for="aasId">AAS ID*</label>
        <input id="aasId" type="text" pInputText formControlName="aasId"/>
      </div>
      <div class="p-field">
        <label for="description">Description</label>
        <textarea
          id="description"
          rows="3"
          pInputTextarea
          formControlName="description"
          style="width: 100%;"
        ></textarea>
      </div>

      <div class="p-field">
        <label for="apiType">Type*</label>
        <p-dropdown id="apiType" [options]="typeOptions" formControlName="apiType"></p-dropdown>
      </div>
      <div class="p-field">
        <label for="apiAuthType">Authentication</label>
        <p-dropdown id="apiAuthType" [options]="authTypeOptions" formControlName="apiAuthType"></p-dropdown>
      </div>
      <div formGroupName="authConfig">
        <ng-container *ngIf="form.get('apiAuthType')?.value === ApiAuthType.Basic">
          <div class="p-field">
            <label for="username">Username*</label>
            <input id="username" type="text" pInputText formControlName="username"/>
          </div>
          <div class="p-field">
            <label for="password">Password*</label>
            <input id="password" type="password" pInputText formControlName="password"/>
          </div>
        </ng-container>
        <ng-container *ngIf="form.get('apiAuthType')?.value === ApiAuthType.ApiKey">
          <div class="p-field">
            <label for="apiKey">API Key*</label>
            <input id="apiKey" type="text" pInputText formControlName="apiKey"/>
          </div>
          <div class="p-field">
            <label for="headerName">Header Name*</label>
            <input id="headerName" type="text" pInputText formControlName="headerName"/>
          </div>
        </ng-container>
      </div>
      <div class="p-field" *ngIf="isRest()">
        <label for="openApiSpec">OpenAPI Spec URL</label>
        <input id="openApiSpec" type="text" pInputText formControlName="openApiSpec" placeholder="https://..."/>
      </div>
      <div class="p-field" *ngIf="isRest()">
        <label>OR Upload File</label>
        <p-fileupload
          #fu
          mode="basic"
          [auto]="false"
          [showUploadButton]="false"
          [showCancelButton]="false"
          accept=".json,.yaml,.yml"
          (onSelect)="onFileSelected($event)" />

        <small *ngIf="selectedFile">{{ selectedFile.name }}</small>
      </div>

      <!-- AAS: Verbindung testen -->
      <div class="p-field" *ngIf="isAas()">
        <button pButton type="button" label="Verbindung testen" (click)="testAasConnection()" [disabled]="isTesting"></button>
        <span *ngIf="isTesting" class="ml-2">Testing...</span>
        <div class="mt-2" *ngIf="aasPreview && aasTestOk">
          <strong>idShort:</strong> {{ aasPreview.idShort }}
          <span class="ml-3"><strong>assetKind:</strong> {{ aasPreview.assetKind }}</span>
        </div>
        <div class="mt-2" *ngIf="aasError && aasTestOk === false" style="color:#d32f2f;">
          {{ aasError }}
        </div>
      </div>
    </form>
  </ng-container>

  <!-- Step 2: API Headers -->
  <ng-container *ngIf="currentStep === 1">
    <app-manage-api-headers
      [syncSystemId]="createdSourceSystemId">
    </app-manage-api-headers>
  </ng-container>

  <!-- Step 3: Endpoints (REST) or AAS Submodels (AAS) -->
  <ng-container *ngIf="currentStep === 2">
    <ng-container *ngIf="isRest(); else aasTree">
      <app-manage-endpoints [sourceSystemId]="createdSourceSystemId"></app-manage-endpoints>
    </ng-container>
    <ng-template #aasTree>
      <div class="p-field">
        <button pButton type="button" label="Discover Submodels" (click)="discoverSubmodels()" [disabled]="isDiscovering"></button>
        <span *ngIf="isDiscovering" class="ml-2">Loading...</span>
      </div>
      <ul>
        <li *ngFor="let sm of submodels">
          <span>{{ (sm.idShort || sm.id || (sm.keys && sm.keys[0]?.value)) }}</span>
        </li>
      </ul>
    </ng-template>
  </ng-container>

  <!-- Common Footer -->
  <ng-template pTemplate="footer">
    <div class="p-d-flex p-jc-between">
      <!-- Back Button -->
      <button
        pButton
        type="button"
        label="Back"
        class="p-button-text"
        (click)="goBack()"
        [disabled]="currentStep === 0">
      </button>

      <!-- Next or Finish -->
      <button
        *ngIf="currentStep === 0 || currentStep === 1"
        pButton
        type="button"
        label="Next"
        (click)="goNext()"
        [disabled]="currentStep === 0 ? !canProceedFromStep1() : false">
      </button>
      <button
        *ngIf="currentStep === 2"
        pButton
        type="button"
        label="Finish"
        (click)="cancel()">
      </button>
    </div>
  </ng-template>
</p-dialog>
