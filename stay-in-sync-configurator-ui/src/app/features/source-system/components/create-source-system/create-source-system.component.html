<p-dialog
  header="Create Source System"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '60vw', height: '90vh' }"
  (onHide)="cancel()"
>
  <!-- Stepper -->
  <p-steps [model]="steps" [activeIndex]="currentStep" class="mb-4"></p-steps>

  <!-- Step 1: Metadata Form (REST | AAS) -->
  <ng-container *ngIf="currentStep === 0">
    <form [formGroup]="form" class="p-fluid">
      <div class="p-field">
        <label for="name">Name*</label>
        <input id="name" type="text" pInputText formControlName="name"/>
      </div>
      <div class="p-field">
        <label for="apiUrl">Base URL*</label>
        <input id="apiUrl" type="text" pInputText formControlName="apiUrl"/>
      </div>
      <!-- AAS-only field -->
      <div class="p-field" *ngIf="isAas()">
        <label for="aasId">AAS ID*</label>
        <input id="aasId" type="text" pInputText formControlName="aasId"/>
      </div>
      <div class="p-field">
        <label for="description">Description</label>
        <textarea
          id="description"
          rows="3"
          pInputTextarea
          formControlName="description"
          style="width: 100%;"
        ></textarea>
      </div>

      <div class="p-field">
        <label for="apiType">Type*</label>
        <p-dropdown id="apiType" [options]="typeOptions" formControlName="apiType"></p-dropdown>
      </div>
      <div class="p-field">
        <label for="apiAuthType">Authentication</label>
        <p-dropdown id="apiAuthType" [options]="authTypeOptions" formControlName="apiAuthType"></p-dropdown>
      </div>
      <div formGroupName="authConfig">
        <ng-container *ngIf="form.get('apiAuthType')?.value === ApiAuthType.Basic">
          <div class="p-field">
            <label for="username">Username*</label>
            <input id="username" type="text" pInputText formControlName="username"/>
          </div>
          <div class="p-field">
            <label for="password">Password*</label>
            <input id="password" type="password" pInputText formControlName="password"/>
          </div>
        </ng-container>
        <ng-container *ngIf="form.get('apiAuthType')?.value === ApiAuthType.ApiKey">
          <div class="p-field">
            <label for="apiKey">API Key*</label>
            <input id="apiKey" type="text" pInputText formControlName="apiKey"/>
          </div>
          <div class="p-field">
            <label for="headerName">Header Name*</label>
            <input id="headerName" type="text" pInputText formControlName="headerName"/>
          </div>
        </ng-container>
      </div>
      <div class="p-field" *ngIf="isRest()">
        <label for="openApiSpec">OpenAPI Spec URL</label>
        <input id="openApiSpec" type="text" pInputText formControlName="openApiSpec" placeholder="https://..."/>
      </div>
      <div class="p-field" *ngIf="isRest()">
        <label>OR Upload File</label>
        <p-fileupload
          #fu
          mode="basic"
          [auto]="false"
          [showUploadButton]="false"
          [showCancelButton]="false"
          accept=".json,.yaml,.yml"
          (onSelect)="onFileSelected($event)" />

        <small *ngIf="selectedFile">{{ selectedFile.name }}</small>
      </div>

      <!-- AAS: Test connection -->
      <div class="p-field" *ngIf="isAas()">
        <button pButton type="button" label="Test connection" (click)="testAasConnection()" [disabled]="isTesting"></button>
        <span *ngIf="isTesting" class="ml-2">Testing...</span>
        <div class="mt-2" *ngIf="aasPreview && aasTestOk">
          <strong>idShort:</strong> {{ aasPreview.idShort }}
          <span class="ml-3"><strong>assetKind:</strong> {{ aasPreview.assetKind }}</span>
        </div>
        <div class="mt-2" *ngIf="aasError && aasTestOk === false" style="color:#d32f2f;">
          {{ aasError }}
        </div>
      </div>
    </form>
  </ng-container>

  <!-- Step 2: API Headers -->
  <ng-container *ngIf="currentStep === 1">
    <app-manage-api-headers
      [syncSystemId]="createdSourceSystemId"
      [isAas]="isAas()"
      [allowValues]="false"
      (onRetest)="testAasConnection()">
    </app-manage-api-headers>
  </ng-container>

  <!-- Step 3: Endpoints (REST) or AAS Submodels (AAS) -->
  <ng-container *ngIf="currentStep === 2">
    <ng-container *ngIf="isRest(); else aasTree">
      <app-manage-endpoints [sourceSystemId]="createdSourceSystemId"></app-manage-endpoints>
    </ng-container>
    <ng-template #aasTree>
      <div class="p-field">
        <button pButton type="button" label="Discover Submodels" (click)="discoverSubmodels()" [disabled]="isDiscovering"></button>
        <button pButton type="button" class="p-button-text ml-2" label="Upload AASX" (click)="openAasxUpload()" [disabled]="!createdSourceSystemId"></button>
        <button pButton type="button" class="p-button-text ml-2" label="+ Submodel" (click)="openCreateSubmodel()"></button>
        <span *ngIf="isDiscovering" class="ml-2">Loading...</span>
      </div>
      <div style="display:flex; gap:1rem; align-items:flex-start;">
        <div style="flex: 1 1 65%; min-width: 0;">
          <p-tree [value]="treeNodes" (onNodeExpand)="onNodeExpand($event)" (onNodeSelect)="onNodeSelect($event)" selectionMode="single">
            <ng-template let-node pTemplate="default">
              <div style="display:flex;align-items:center;gap:.5rem;">
                <span>{{ node.label }}</span>
                <span style="font-size:.75rem;padding:.1rem .4rem;border-radius:999px;border:1px solid var(--surface-border);color:var(--text-color-secondary);">
                  {{ node.data?.type==='submodel' ? 'Submodel' : (node.data?.modelType || node.data?.raw?.modelType || (node.data?.raw?.valueType ? 'Property' : 'Element')) }}
                </span>
                <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text" label="Create element" (click)="openCreateElement(node.data.id)"></button>
                <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text p-button-danger" label="Delete submodel" (click)="deleteSubmodel(node.data.id)"></button>
                <!-- <button *ngIf="node.data?.type==='element' && node.data?.modelType!=='Property'" pButton type="button" class="p-button-text" label="Add child" (click)="openCreateElement(node.data.submodelId, node.data.idShortPath)"></button> -->
                <button *ngIf="node.data?.type==='element' && (node.data?.modelType==='Property' || node.data?.raw?.valueType)" pButton type="button" class="p-button-text" label="Set value" (click)="openSetValue(node.data.submodelId, node.data)"></button>
                <button *ngIf="node.data?.type==='element'" pButton type="button" class="p-button-text p-button-danger" label="Delete" (click)="deleteElement(node.data.submodelId, node.data.idShortPath)"></button>
              </div>
            </ng-template>
          </p-tree>
        </div>
        <div class="p-card" *ngIf="selectedNode && selectedNode.data?.type==='element'" style="flex: 0 0 35%; padding:1rem;border:1px solid var(--surface-border);border-radius:4px;">
          <div class="p-d-flex p-ai-center p-jc-between">
            <h4 style="margin:0;">Details</h4>
            <span *ngIf="selectedLiveLoading">Loading...</span>
          </div>
          <div *ngIf="selectedLivePanel">
            <div><strong>Label:</strong> {{ selectedLivePanel.label }}</div>
            <div><strong>Type:</strong> {{ selectedLivePanel.type }}</div>
            <div *ngIf="selectedLivePanel.valueType"><strong>valueType:</strong> {{ selectedLivePanel.valueType }}</div>
            <div *ngIf="selectedLivePanel.value !== undefined"><strong>value:</strong> {{ selectedLivePanel.value }}</div>
            <div *ngIf="selectedLivePanel.type==='Range' || selectedLivePanel.min !== undefined || selectedLivePanel.max !== undefined">
              <div><strong>min:</strong> {{ selectedLivePanel.min }}</div>
              <div><strong>max:</strong> {{ selectedLivePanel.max }}</div>
            </div>
            <div *ngIf="selectedLivePanel.type==='Operation'">
              <div *ngIf="selectedLivePanel.inputVariables?.length">
                <strong>Inputs:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of selectedLivePanel.inputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
              <div *ngIf="selectedLivePanel.inoutputVariables?.length">
                <strong>In/Out:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of selectedLivePanel.inoutputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
              <div *ngIf="selectedLivePanel.outputVariables?.length">
                <strong>Outputs:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of selectedLivePanel.outputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
            </div>
            <div *ngIf="selectedLivePanel.type==='RelationshipElement' || selectedLivePanel.type==='AnnotatedRelationshipElement'">
              <div *ngIf="selectedLivePanel.firstRef"><strong>First:</strong> {{ selectedLivePanel.firstRef }}</div>
              <div *ngIf="selectedLivePanel.secondRef"><strong>Second:</strong> {{ selectedLivePanel.secondRef }}</div>
              <div *ngIf="selectedLivePanel.type==='AnnotatedRelationshipElement' && selectedLivePanel.annotations?.length">
                <strong>Annotations:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let a of selectedLivePanel.annotations; let i = index">
                    <div><strong>{{ a.idShort || ('Annotation ' + (i+1)) }}</strong></div>
                    <div *ngIf="a.valueType"><em>valueType:</em> {{ a.valueType }}</div>
                    <div *ngIf="a.value !== undefined"><em>value:</em> {{ (a.value | json) }}</div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ng-container>

  <!-- Common Footer -->
  <ng-template pTemplate="footer">
    <div class="p-d-flex p-jc-between">
      <button pButton type="button" label="Back" class="p-button-text" (click)="goBack()" [disabled]="currentStep === 0"></button>
      <button *ngIf="currentStep === 0 || currentStep === 1" pButton type="button" label="Next" (click)="goNext()" [disabled]="currentStep === 0 ? !canProceedFromStep1() : false"></button>
      <button *ngIf="currentStep === 2" pButton type="button" label="Finish" (click)="cancel()"></button>
    </div>
  </ng-template>
</p-dialog>
<!-- Dialog: Confirm Delete Submodel -->
<p-dialog header="Delete Submodel" [(visible)]="showDeleteSubmodelDialog" [modal]="true" [style]="{width:'32vw'}">
  <p>Do you really want to delete this submodel? All its elements and the shell reference will be removed. This action cannot be undone.</p>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showDeleteSubmodelDialog=false"></button>
    <button pButton type="button" class="p-button-danger" label="Delete" (click)="proceedDeleteSubmodel()"></button>
  </ng-template>
</p-dialog>


<!-- Dialog: Create Submodel -->
<p-dialog header="Create Submodel" [(visible)]="showSubmodelDialog" [modal]="true" [style]="{width:'40vw'}">
  <textarea pInputTextarea [(ngModel)]="newSubmodelJson" rows="10" style="width:100%"></textarea>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showSubmodelDialog=false"></button>
    <button pButton type="button" label="Create" (click)="createSubmodel()"></button>
  </ng-template>
  <div class="p-mt-2" style="display:flex;gap:.5rem;flex-wrap:wrap;">
    <button pButton type="button" class="p-button-text" label="Template: Minimal" (click)="setSubmodelTemplate('minimal')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Property" (click)="setSubmodelTemplate('property')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Collection" (click)="setSubmodelTemplate('collection')"></button>
  </div>
</p-dialog>

<!-- Dialog: Create Element -->
<p-dialog header="Create Element" [(visible)]="showElementDialog" [modal]="true" [style]="{width:'40vw'}">
  <div class="p-field">
    <label>Submodel ID</label>
    <input pInputText [value]="targetSubmodelId" disabled />
  </div>
  <div class="p-field">
    <label>Parent Path</label>
    <input pInputText [(ngModel)]="parentPath" placeholder="e.g. address or address/street" />
    <small>Optional. Use idShort path with slashes for nesting.</small>
  </div>
  <textarea pInputTextarea [(ngModel)]="newElementJson" rows="10" style="width:100%"></textarea>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showElementDialog=false"></button>
    <button pButton type="button" label="Create" (click)="createElement()"></button>
  </ng-template>
  <button pButton type="button" class="p-button-text" label="Use example" (click)="newElementJson='{}'"></button>
</p-dialog>

<!-- Dialog: Upload AASX -->
<p-dialog header="Upload AASX" [(visible)]="showAasxUpload" [modal]="true" [style]="{width:'35vw'}">
  <div class="p-field">
    <p-fileupload mode="basic" [auto]="false" [showUploadButton]="false" [showCancelButton]="false" accept=".aasx" (onSelect)="onAasxFileSelected($event)"></p-fileupload>
    <small *ngIf="aasxSelectedFile">{{ aasxSelectedFile.name }}</small>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasxUpload=false"></button>
    <button pButton type="button" label="Upload" (click)="uploadAasx()" [disabled]="isUploadingAasx || !aasxSelectedFile"></button>
  </ng-template>
</p-dialog>

<!-- Dialog: Set Property Value -->
<p-dialog header="Set Property Value" [(visible)]="showValueDialog" [modal]="true" [style]="{width:'35vw'}">
  <div class="p-field">
    <label>Submodel ID</label>
    <input pInputText [value]="valueSubmodelId" disabled />
  </div>
  <div class="p-field">
    <label>Element Path</label>
    <input pInputText [value]="valueElementPath" disabled />
  </div>
  <div class="p-field">
    <label>New Value</label>
    <input pInputText [(ngModel)]="valueNew" />
    <small>valueType: {{ valueTypeHint }}</small>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showValueDialog=false"></button>
    <button pButton type="button" label="Save" (click)="setValue()"></button>
  </ng-template>
</p-dialog>
