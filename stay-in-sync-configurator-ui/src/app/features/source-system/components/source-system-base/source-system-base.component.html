<!--
  -------------------------------------------------------------------------------------------------
  Base view: list, create, and delete source systems
  -------------------------------------------------------------------------------------------------
-->
<p-card>
  <p-toolbar>
    <div class="p-toolbar-group-left">
      <h3>Source Systems</h3>
    </div>
    <div class="p-toolbar-group-right">
      <button pButton type="button" label="Create Source System" icon="pi pi-plus" (click)="openCreate()"></button>
    </div>
  </p-toolbar>

  <!--
    Search functionality
  -->
  <div class="search-section" 
       role="region" 
       [attr.aria-label]="'Search source systems'"
       [attr.aria-describedby]="'search-instructions'">
    <div class="search-container">
      <app-search-bar
        [customPlaceholder]="getResponsivePlaceholder()"
        [resultCount]="searchResultCount?.filtered || 0"
        [loading]="loading"
        (search)="onSearchChange($event)"
        (clear)="onSearchClear()">
      </app-search-bar>
    </div>
    
    <!-- Search result count display -->
    <div class="search-results-info" 
         *ngIf="searchResultCount"
         role="status"
         [attr.aria-live]="'polite'"
         [attr.aria-atomic]="true">
      <span [class.text-success]="searchResultCount.hasResults" [class.text-muted]="!searchResultCount.hasResults">
        {{ searchResultCount.displayText }}
      </span>
    </div>
    
    <!-- Hidden accessibility instructions -->
    <div class="sr-only" id="search-instructions">
      Use the search bar above to find source systems by name, description, API URL, endpoints, or headers. 
      Results will be displayed in the table below. Use keyboard shortcuts: Enter to search, Escape to clear.
    </div>
  </div>

  <!--
    Table of source systems with pagination and action buttons
  -->
  <p-table 
    [value]="getDisplaySystems()" 
    [loading]="loading" 
    [paginator]="true" 
    [rows]="getResponsiveTableRows()" 
    [responsiveLayout]="'scroll'"
    [showCurrentPageReport]="!isSmallScreen()"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [rowsPerPageOptions]="isSmallScreen() ? [5, 10] : [5, 10, 25, 50]"
    [globalFilterFields]="['name', 'apiUrl', 'description']"

    [scrollable]="true"
    [scrollHeight]="isSmallScreen() ? '300px' : '400px'"
    [virtualScroll]="filteredSystems.length > 100 && !isSmallScreen()"
    [virtualScrollItemSize]="isSmallScreen() ? 40 : 46"
    [virtualScrollOptions]="{ itemSize: isSmallScreen() ? 40 : 46 }"
    [class.search-active]="isSearchActive"
    [class.has-highlighting]="searchOptions && searchOptions.highlightMatches"
    [class.mobile-device]="isMobileDevice()"
    [class.small-screen]="isSmallScreen()"
    [class.touch-device]="isTouchDevice()">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="min-width: 200px;">
          <div class="column-header">
            <span>Name</span>
            <div class="search-indicator" *ngIf="hasNameMatches()">
              <i class="pi pi-search" title="Name matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 250px;">
          <div class="column-header">
            <span>API URL</span>
            <div class="search-indicator" *ngIf="hasUrlMatches()">
              <i class="pi pi-search" title="URL matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 300px;">
          <div class="column-header">
            <span>Description</span>
            <div class="search-indicator" *ngIf="hasDescriptionMatches()">
              <i class="pi pi-search" title="Description matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 150px;">
          <div class="column-header">
            <span>Actions</span>
            <div class="search-indicator" *ngIf="hasEndpointMatches() || hasHeaderMatches()">
              <i class="pi pi-cog" title="Endpoint/Header matches found"></i>
            </div>
          </div>
        </th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-system let-rowIndex="rowIndex">
      <tr [class.search-result]="isSearchActive" [class.highlighted-row]="isHighlightedRow(system)">
        <td>
          <div class="system-name-cell">
            <div class="system-name" [innerHTML]="getHighlightedText(system.name, 'name')"></div>
            <div class="system-meta" *ngIf="isSearchActive">
              <small class="relevance-score" *ngIf="getRelevanceScore(system) > 0">
                Relevance: {{ getRelevanceScore(system) }}%
              </small>
            </div>
          </div>
        </td>
        <td>
          <div class="api-url-cell">
            <div class="api-url" [innerHTML]="getHighlightedText(system.apiUrl, 'url')"></div>
            <div class="api-type" *ngIf="system.apiType">
              <span class="api-type-badge">{{ system.apiType }}</span>
            </div>
          </div>
        </td>
        <td>
          <div class="description-cell">
            <div class="description-text" [innerHTML]="getHighlightedText(system.description, 'description')"></div>
            <div class="description-meta" *ngIf="isSearchActive && hasEndpointMatches()">
              <small class="endpoint-matches" *ngIf="getEndpointMatchCount(system) > 0">
                {{ getEndpointMatchCount(system) }} endpoint(s) match
              </small>
            </div>
          </div>
        </td>
        <td>
          <div class="actions-cell">
            <!-- Manage Source System -->
            <button pButton 
                    type="button" 
                    label="Manage" 
                    class="p-button-text p-button-sm" 
                    (click)="viewSourceSystem(system)"
                    [title]="'Manage ' + system.name">
            </button>
            <!-- Delete Source System -->
            <button pButton 
                    type="button" 
                    icon="pi pi-trash" 
                    class="p-button-text p-button-sm p-button-danger" 
                    (click)="deleteSourceSystem(system)"
                    [title]="'Delete ' + system.name">
            </button>
            <!-- Quick search actions -->
            <div class="quick-search-actions" *ngIf="isSearchActive">
              <button pButton 
                      type="button" 
                      icon="pi pi-search" 
                      class="p-button-text p-button-sm p-button-info" 
                      (click)="showSearchDetails(system)"
                      [title]="'Show search details for ' + system.name">
              </button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <div class="empty-icon">
              <i class="pi pi-search" *ngIf="isSearchActive"></i>
              <i class="pi pi-database" *ngIf="!isSearchActive"></i>
            </div>
            <div class="empty-message">
              <h4>{{ getEmptyMessage() }}</h4>
              <p *ngIf="isSearchActive">
                No source systems found matching "{{ searchTerm }}"
              </p>
              <p *ngIf="!isSearchActive">
                No source systems available. Create your first source system to get started.
              </p>
            </div>
            <div class="empty-actions" *ngIf="isSearchActive">
              <button pButton 
                      type="button" 
                      label="Clear Search" 
                      class="p-button-text" 
                      (click)="onSearchClear()">
              </button>
              <button pButton 
                      type="button" 
                      label="Try Different Terms" 
                      class="p-button-text" 
                      (click)="showSearchSuggestions()">
              </button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="footer" *ngIf="isSearchActive && shouldShowSearchActions()">
      <tr>
        <td colspan="4">
          <div class="search-footer">
            <div class="search-stats">
              <span class="search-performance" *ngIf="getSearchPerformance().duration > 0 && !isSmallScreen()">
                Search completed in {{ getSearchPerformance().duration.toFixed(0) }}ms
              </span>
              <span class="search-breakdown" *ngIf="getSearchBreakdown() && shouldShowSearchBreakdown()">
                {{ getSearchBreakdownText() }}
              </span>
            </div>
            <div class="search-actions" *ngIf="shouldShowSearchActions()">
              <button pButton 
                      type="button" 
                      label="Export Results" 
                      class="p-button-text p-button-sm" 
                      (click)="exportSearchResults()"
                      [disabled]="!hasSearchResults()">
              </button>
              <button pButton 
                      type="button" 
                      label="Save Search" 
                      class="p-button-text p-button-sm" 
                      (click)="saveSearchQuery()"
                      [disabled]="!isSearchActive">
              </button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-message *ngIf="errorMsg" severity="error" text="{{ errorMsg }}"></p-message>
</p-card>

<!--
  Dialog component for creating or editing a source system
-->
<app-create-source-system
  [(visible)]="showCreateDialog"
  [sourceSystem]="selectedSystem"
  (visibleChange)="onCreateDialogClose($event)">
</app-create-source-system>

<!--
  Detail dialog for metadata, API headers, and endpoints management of a selected system
-->
<p-dialog header="Manage Source System" [(visible)]="showDetailDialog" [modal]="true" [style]="{ width: '80vw', height: '80vh' }" (onHide)="closeDetailDialog()">
  <ng-container *ngIf="selectedSystem">
    <!--
      Metadata edit form for selected source system
    -->
    <div style="margin-bottom: 2rem;"></div>
    <div style="display: flex; align-items: center; cursor: pointer;" (click)="toggleMetadataSection()">
      <h3 style="flex: 1 1 auto; margin: 0;">Metadata</h3>
      <i class="pi" [ngClass]="showMetadataSection ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
    </div>
    <div *ngIf="showMetadataSection">
      <form [formGroup]="metadataForm" (ngSubmit)="saveMetadata()">
        <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
          <label for="metaName">Name</label>
          <input id="metaName" pInputText formControlName="name" />
        </div>
        
        <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
          <label for="metaUrl">API URL</label>
          <input id="metaUrl" pInputText formControlName="apiUrl" />
        </div>
        
        <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
          <label for="metaDesc" class="p-d-block">Description</label>
          <textarea id="metaDesc" pInputTextarea formControlName="description" rows="3" class="p-inputtextarea p-d-block"></textarea>
        </div>
        
        <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
          <label for="metaOpenApiSpec">OpenAPI Spec URL</label>
          <input id="metaOpenApiSpec" pInputText formControlName="openApiSpec" placeholder="https://..." />
        </div>
        
        <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
          <label>OR Upload File</label>
          <p-fileupload #fu mode="basic" chooseLabel="Choose" chooseIcon="pi pi-upload" name="demo[]"
                        url="https://www.primefaces.org/cdn/api/upload.php" accept=".json,.yaml,.yml"
                        (onUpload)="onFileSelected($event)"/>
          <small *ngIf="selectedFile">{{ selectedFile.name }}</small>
        </div>
        
        <div style="margin-bottom: 2rem;"></div>
        
        <div class="p-col-12 p-md-3 p-d-flex p-ai-end p-jc-end">
          <button pButton label="Save Metadata"
                  type="submit"
                  [disabled]="metadataForm.invalid"></button>
        </div>
      </form>
    </div>
    <div class="p-grid p-m-2">
      <div class="p-col-12 p-md-6">
        <p-card>
          <div style="display: flex; align-items: center; cursor: pointer;" (click)="toggleHeadersSection()">
            <h4 style="flex: 1 1 auto; margin: 0;">API Headers</h4>
            <i class="pi" [ngClass]="showHeadersSection ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
          </div>
          <div *ngIf="showHeadersSection">
            <app-manage-api-headers [syncSystemId]="selectedSystem!.id!"></app-manage-api-headers>
          </div>
        </p-card>
      </div>
      <div class="p-col-12 p-md-6">
        <p-card>
          <div style="display: flex; align-items: center; cursor: pointer;" (click)="toggleEndpointsSection()">
            <h4 style="flex: 1 1 auto; margin: 0;">Endpoints</h4>
            <i class="pi" [ngClass]="showEndpointsSection ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
          </div>
          <div *ngIf="showEndpointsSection">
            <app-manage-endpoints [sourceSystemId]="selectedSystem!.id!"></app-manage-endpoints>
          </div>
        </p-card>
      </div>
    </div>
  </ng-container>
</p-dialog>

<!--
  Confirmation dialog for deletion
-->
<app-confirmation-dialog
  [(visible)]="showConfirmationDialog"
  [data]="confirmationData"
  (confirmed)="onConfirmationConfirmed()"
  (cancelled)="onConfirmationCancelled()">
</app-confirmation-dialog>