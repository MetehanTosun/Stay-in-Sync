<!--
  Source System Base Component
  Main view for managing source systems including listing, searching, creating, and deleting.
  Provides comprehensive search functionality with highlighting and responsive design.
-->
<p-card>
  <app-search-bar
    [customPlaceholder]="'Search source systems by name, description, API URL, endpoints, or headers...'"
    (search)="onSearchChange($event)"
    (clear)="onSearchClear()">
  </app-search-bar>
  <!-- Header toolbar with title and create button -->
  <p-toolbar>
    <div class="p-toolbar-group-left">
      <h3>Source Systems</h3>
    </div>
    <div class="p-toolbar-group-right">
      <button pButton type="button" label="Create Source System" icon="pi pi-plus" (click)="openCreate()"></button>
    </div>
  </p-toolbar>


  <!--
    Table of source systems with pagination and action buttons
  -->
  <p-table [value]="systems" [loading]="loading" [paginator]="true" [rows]="10" [responsiveLayout]="'scroll'">
    <ng-template pTemplate="header">
      <tr>
        <th style="min-width: 200px;">
          <div class="column-header">
            <span>Name</span>
            <div class="search-indicator" *ngIf="hasNameMatches()">
              <i class="pi pi-search" title="Name matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 250px;">
          <div class="column-header">
            <span>API URL</span>
            <div class="search-indicator" *ngIf="hasUrlMatches()">
              <i class="pi pi-search" title="URL matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 300px;">
          <div class="column-header">
            <span>Description</span>
            <div class="search-indicator" *ngIf="hasDescriptionMatches()">
              <i class="pi pi-search" title="Description matches found"></i>
            </div>
          </div>
        </th>
        <th style="min-width: 150px;">
          <div class="column-header">
            <span>Actions</span>
            <div class="search-indicator" *ngIf="hasEndpointMatches() || hasHeaderMatches()">
              <i class="pi pi-cog" title="Endpoint/Header matches found"></i>
            </div>
          </div>
        </th>
      </tr>
    </ng-template>

    <!-- Table body with search highlighting and action buttons -->
    <ng-template pTemplate="body" let-system let-rowIndex="rowIndex">
      <tr [class.search-result]="isSearchActive" [class.highlighted-row]="isHighlightedRow(system)">
        <td>
          <div class="system-name-cell">
            <div class="system-name" [innerHTML]="getHighlightedText(system.name, 'name')"></div>
            <div class="system-meta" *ngIf="isSearchActive">
              <small class="relevance-score" *ngIf="getRelevanceScore(system) > 0">
                Relevance: {{ getRelevanceScore(system) }}%
              </small>
            </div>
          </div>
        </td>
        <td>
          <div class="api-url-cell">
            <div class="api-url" [innerHTML]="getHighlightedText(system.apiUrl, 'url')"></div>
            <div class="api-type" *ngIf="system.apiType">
              <span class="api-type-badge">{{ system.apiType }}</span>
            </div>
          </div>
        </td>
        <td>
          <div class="description-cell">
            <div class="description-text" [innerHTML]="getHighlightedText(system.description, 'description')"></div>
            <div class="description-meta" *ngIf="isSearchActive && hasEndpointMatches()">
              <small class="endpoint-matches" *ngIf="getEndpointMatchCount(system) > 0">
                {{ getEndpointMatchCount(system) }} endpoint(s) match
              </small>
            </div>
          </div>
        </td>
        <td>
          <div class="actions-cell">
            <!-- Manage button to view and edit source system details -->
            <button pButton
                    type="button"
                    label="Manage"
                    class="p-button-text p-button-sm"
                    (click)="viewSourceSystem(system)"
                    [title]="'Manage ' + system.name">
            </button>
            <!-- Delete button to remove source system -->
            <button pButton
                    type="button"
                    icon="pi pi-trash"
                    class="p-button-text p-button-sm p-button-danger"
                    (click)="deleteSourceSystem(system)"
                    [title]="'Delete ' + system.name">
            </button>
            <!-- Quick search actions for detailed search information -->
            <div class="quick-search-actions" *ngIf="isSearchActive">
              <button pButton
                      type="button"
                      icon="pi pi-search"
                      class="p-button-text p-button-sm p-button-info"
                      (click)="showSearchDetails(system)"
                      [title]="'Show search details for ' + system.name">
              </button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty state message when no data is available -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4">
          <div class="empty-state">
            <div class="empty-icon">
              <i class="pi pi-search" *ngIf="isSearchActive"></i>
              <i class="pi pi-database" *ngIf="!isSearchActive"></i>
            </div>
            <div class="empty-message">
              <h4>{{ getEmptyMessage() }}</h4>
              <p *ngIf="isSearchActive">
                No source systems found matching "{{ searchTerm }}"
              </p>
              <p *ngIf="!isSearchActive">
                No source systems available. Create your first source system to get started.
              </p>
            </div>
            <div class="empty-actions" *ngIf="isSearchActive">
              <button pButton
                      type="button"
                      label="Clear Search"
                      class="p-button-text"
                      (click)="onSearchClear()">
              </button>
              <button pButton
                      type="button"
                      label="Show All"
                      class="p-button-text"
                      (click)="onSearchClear()">
              </button>
            </div>
            <div class="empty-actions" *ngIf="!isSearchActive">
              <button pButton
                      type="button"
                      label="Create Source System"
                      icon="pi pi-plus"
                      (click)="openCreate()">
              </button>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Search footer with statistics and actions -->
  <div class="search-footer" *ngIf="isSearchActive && searchResultCount">
    <div class="search-stats">
      <small class="search-performance">
        Search completed in {{ getSearchPerformance().duration }}ms
      </small>
    </div>
    <div class="search-actions">
      <button pButton
              type="button"
              label="Export Results"
              icon="pi pi-download"
              class="p-button-text p-button-sm"
              (click)="exportSearchResults()"
              [disabled]="!hasSearchResults()">
      </button>
      <button pButton
              type="button"
              label="Save Query"
              icon="pi pi-save"
              class="p-button-text p-button-sm"
              (click)="saveSearchQuery()"
              [disabled]="!hasSearchResults()">
      </button>
    </div>
  </div>
</p-card>

<!-- Shared confirmation dialog for delete -->
<app-confirmation-dialog
  [(visible)]="showConfirmationDialog"
  [data]="confirmationData"
  (confirmed)="onConfirmationConfirmed()"
  (cancelled)="onConfirmationCancelled()">
</app-confirmation-dialog>

<!-- Create Source System Dialog -->
<app-create-source-system
  [(visible)]="showCreateDialog"
  (visibleChange)="onCreateDialogClose($event)">
</app-create-source-system>

<!--
  Detail dialog for metadata, API headers, and endpoints management of a selected system
-->
<p-dialog header="Manage Source System" [(visible)]="showDetailDialog" [modal]="true" [style]="{ width: '80vw', height: '80vh' }" (onHide)="closeDetailDialog()">
  <ng-container *ngIf="selectedSystem">
    <!--
      Metadata edit form for selected source system
    -->
    <form [formGroup]="metadataForm" (ngSubmit)="saveMetadata()">
      <div style="margin-bottom: 2rem;"></div>
      <!-- Metadata edit form -->
      <h3 style="margin-bottom: 1.5rem;">Metadata</h3>

      <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
        <label for="metaName">Name</label>
        <input id="metaName" pInputText formControlName="name" />
      </div>

      <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
        <label for="metaUrl">API URL</label>
        <input id="metaUrl" pInputText formControlName="apiUrl" />
      </div>

      <div class="p-col-12 p-md-3" style="margin-bottom: 1.5rem;">
        <label for="metaDesc" class="p-d-block">Description</label>
        <textarea id="metaDesc" pInputTextarea formControlName="description" rows="3" class="p-inputtextarea p-d-block"></textarea>
      </div>


      <div style="margin-bottom: 2rem;"></div>

      <div class="p-col-12 p-md-3 p-d-flex p-ai-end p-jc-end">
        <button pButton label="Save Metadata"
                type="submit"
                [disabled]="metadataForm.invalid"></button>
      </div>
    </form>
    <p-tabView>
      <p-tabPanel *ngIf="!isAasSelected()" header="Headers & Endpoints">
        <div class="p-grid p-m-2">
          <div class="p-col-12 p-md-6">
            <p-card>
              <h4>API Headers</h4>
              <app-manage-api-headers [syncSystemId]="selectedSystem!.id!"></app-manage-api-headers>
            </p-card>
          </div>
          <div class="p-col-12 p-md-6">
            <p-card>
              <h4>Endpoints</h4>
              <app-manage-endpoints [sourceSystemId]="selectedSystem!.id!"></app-manage-endpoints>
            </p-card>
          </div>
        </div>
      </p-tabPanel>
      <p-tabPanel *ngIf="isAasSelected()" header="AAS Snapshot">
        <div class="p-d-flex p-ai-center p-jc-between" style="margin-bottom: .5rem;">
          <div>
            <strong>Base URL:</strong> {{ selectedSystem.apiUrl }}
            <span class="ml-3"><strong>AAS ID:</strong> {{ selectedSystem.aasId || '-' }}</span>
          </div>
          <div>
            <button pButton type="button" label="Refresh Snapshot" class="p-button-text" (click)="discoverAasSnapshot()" [disabled]="aasTreeLoading"></button>
            <button pButton type="button" label="+ Submodel" class="p-button-text" (click)="openAasCreateSubmodel()"></button>
          </div>
        </div>
        <button pButton type="button" label="Load Snapshot" (click)="discoverAasSnapshot()" [disabled]="aasTreeLoading"></button>
        <span *ngIf="aasTreeLoading" class="ml-2">Loading...</span>
        <div style="display:flex; gap:1rem; align-items:flex-start;">
          <div style="flex: 1 1 65%; min-width: 0;">
            <p-tree [value]="aasTreeNodes" (onNodeExpand)="onAasNodeExpand($event)" (onNodeSelect)="onAasNodeSelect($event)" selectionMode="single">
              <ng-template let-node pTemplate="default">
                <div style="display:flex;align-items:center;gap:.5rem;">
                  <span>{{ node.label }}</span>
                  <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text" label="Create element" (click)="openAasCreateElement(node.data.id)"></button>
                  <!-- <button *ngIf="node.data?.type==='element' && node.data?.modelType!=='Property'" pButton type="button" class="p-button-text" label="Add child" (click)="openAasCreateElement(node.data.submodelId, node.data.idShortPath)"></button> -->
                  <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text p-button-danger" label="Delete submodel" (click)="deleteAasSubmodel(node.data.id)"></button>
                  <button *ngIf="node.data?.type==='element'" pButton type="button" class="p-button-text p-button-danger" label="Delete" (click)="deleteAasElement(node.data.submodelId, node.data.idShortPath)"></button>
                  <button *ngIf="node.data?.type==='element' && (node.data?.modelType==='Property' || node.data?.raw?.valueType)" pButton type="button" class="p-button-text" label="Set value" (click)="openAasSetValue(node.data.submodelId, node.data)"></button>
                </div>
              </ng-template>
            </p-tree>
          </div>
          <div class="p-card" *ngIf="selectedAasNode && selectedAasNode.data?.type==='element'" style="flex: 0 0 35%; padding:1rem;border:1px solid var(--surface-border);border-radius:4px;">
            <div class="p-d-flex p-ai-center p-jc-between">
              <h4 style="margin:0;">Details</h4>
              <span *ngIf="aasSelectedLiveLoading">Loading...</span>
            </div>
            <div *ngIf="aasSelectedLivePanel">
              <div><strong>Label:</strong> {{ aasSelectedLivePanel.label }}</div>
              <div><strong>Type:</strong> {{ aasSelectedLivePanel.type }}</div>
              <div *ngIf="aasSelectedLivePanel.valueType"><strong>valueType:</strong> {{ aasSelectedLivePanel.valueType }}</div>
              <div *ngIf="aasSelectedLivePanel.value !== undefined"><strong>value:</strong> {{ aasSelectedLivePanel.value }}</div>
              <div *ngIf="aasSelectedLivePanel.type==='Range' || aasSelectedLivePanel.min !== undefined || aasSelectedLivePanel.max !== undefined">
                <div><strong>min:</strong> {{ aasSelectedLivePanel.min }}</div>
                <div><strong>max:</strong> {{ aasSelectedLivePanel.max }}</div>
              </div>
              <div *ngIf="aasSelectedLivePanel.type==='Operation'">
                <div *ngIf="aasSelectedLivePanel.inputVariables?.length">
                  <strong>Inputs:</strong>
                  <ul style="margin:.25rem 0 .5rem 1rem;">
                    <li *ngFor="let v of aasSelectedLivePanel.inputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                  </ul>
                </div>
                <div *ngIf="aasSelectedLivePanel.inoutputVariables?.length">
                  <strong>In/Out:</strong>
                  <ul style="margin:.25rem 0 .5rem 1rem;">
                    <li *ngFor="let v of aasSelectedLivePanel.inoutputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                  </ul>
                </div>
                <div *ngIf="aasSelectedLivePanel.outputVariables?.length">
                  <strong>Outputs:</strong>
                  <ul style="margin:.25rem 0 .5rem 1rem;">
                    <li *ngFor="let v of aasSelectedLivePanel.outputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
      <p-tabPanel *ngIf="isAasSelected()" header="AAS Configuration">
        <div class="p-grid p-fluid">
          <div class="p-col-12 p-md-6">
            <label>Base URL</label>
            <input pInputText [value]="selectedSystem.apiUrl" disabled />
          </div>
          <div class="p-col-12 p-md-6">
            <label>AAS ID</label>
            <input pInputText [(ngModel)]="selectedSystem.aasId" placeholder="AAS Identifier" />
          </div>
        </div>
        <div class="p-d-flex p-ai-center" style="margin-top: .75rem; gap: .5rem;">
          <button pButton type="button" label="Test" (click)="aasTest()" [disabled]="aasTestLoading"></button>
          <span *ngIf="aasTestLoading">Testing...</span>
          <small *ngIf="aasTestError" style="color:#d32f2f;">{{ aasTestError }}</small>
        </div>
      </p-tabPanel>
      <p-tabPanel *ngIf="isAasSelected()" header="AAS Actions">
        <div class="p-d-flex p-ai-center" style="gap: .75rem;">
          <button pButton type="button" label="Refresh Snapshot" (click)="discoverAasSnapshot()" [disabled]="aasTreeLoading"></button>
        </div>
      </p-tabPanel>
    </p-tabView>

<!-- Dialog: Set Property Value (AAS Manage) -->
<p-dialog header="Set Property Value" [(visible)]="showAasValueDialog" [modal]="true" [style]="{width:'35vw'}">
  <div class="p-field">
    <label>Submodel ID</label>
    <input pInputText [value]="aasValueSubmodelId" disabled />
  </div>
  <div class="p-field">
    <label>Element Path</label>
    <input pInputText [value]="aasValueElementPath" disabled />
  </div>
  <div class="p-field">
    <label>New Value</label>
    <input pInputText [(ngModel)]="aasValueNew" />
    <small>valueType: {{ aasValueTypeHint }}</small>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasValueDialog=false"></button>
    <button pButton type="button" label="Save" (click)="aasSetValue()"></button>
  </ng-template>
</p-dialog>

<!-- Dialog: Create Submodel (AAS Manage) -->
<p-dialog header="Create Submodel" [(visible)]="showAasSubmodelDialog" [modal]="true" [style]="{width:'40vw'}">
  <textarea pInputTextarea [(ngModel)]="aasNewSubmodelJson" rows="10" style="width:100%"></textarea>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasSubmodelDialog=false"></button>
    <button pButton type="button" label="Create" (click)="aasCreateSubmodel()"></button>
  </ng-template>
  <div class="p-mt-2" style="display:flex;gap:.5rem;flex-wrap:wrap;">
    <button pButton type="button" class="p-button-text" label="Template: Minimal" (click)="setAasSubmodelTemplate('minimal')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Property" (click)="setAasSubmodelTemplate('property')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Collection" (click)="setAasSubmodelTemplate('collection')"></button>
  </div>
</p-dialog>

<!-- Dialog: Create Element (AAS Manage) -->
<p-dialog header="Create Element" [(visible)]="showAasElementDialog" [modal]="true" [style]="{width:'40vw'}">
  <div class="p-field">
    <label>Submodel ID</label>
    <input pInputText [value]="aasTargetSubmodelId" disabled />
  </div>
  <div class="p-field">
    <label>Parent Path</label>
    <input pInputText [(ngModel)]="aasParentPath" placeholder="e.g. address or address/street" />
    <small>Optional. Use idShort path with slashes for nesting.</small>
  </div>
  <textarea pInputTextarea [(ngModel)]="aasNewElementJson" rows="10" style="width:100%"></textarea>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasElementDialog=false"></button>
    <button pButton type="button" label="Create" (click)="aasCreateElement()"></button>
  </ng-template>
  <button pButton type="button" class="p-button-text" label="Use example" (click)="aasNewElementJson='{}'"></button>
</p-dialog>
  </ng-container>
</p-dialog>