<div>
  <p-tabView *ngIf="selectedSystem">

    <p-tabPanel header="System">

      <div class="flex align-items-center gap-3">
        <label class="text-xl font-bold" style="line-height: 3rem;">System Name:</label>
        <span>
          <p-inplace #inplace (onActivate)="onInplaceActivate()" styleClass="flex align-items-center">
          <ng-template pTemplate="display">
            <span class="text-xl font-semibold">{{ selectedSystem?.name }}</span>
          </ng-template>

          <ng-template pTemplate="content" let-closeCallback="closeCallback">
      <span class="inline-flex align-items-center gap-2">
        <input
          type="text"
          [(ngModel)]="selectedSystem!.name"
          pInputText
          autofocus
          (keyup.enter)="onSave(closeCallback)"/>
        <p-button icon="pi pi-times" aria-label="Cancel" (click)="onClose(closeCallback)" text severity="danger"/>
        <p-button icon="pi pi-check" aria-label="Save" (click)="onSave(closeCallback)" text severity="success"/>
      </span>
          </ng-template>
        </p-inplace>
                  </span>

      </div>

      <div class="flex align-items-center gap-3">
        <label class="text-xl font-bold" style="line-height: 3rem;">Api address:</label>
        <span>
          <p-inplace #inplace (onActivate)="onInplaceActivate()" styleClass="flex align-items-center">
          <ng-template pTemplate="display">
            <span class="text-xl font-semibold">{{ selectedSystem?.apiUrl }}</span>
          </ng-template>

          <ng-template pTemplate="content" let-closeCallback="closeCallback">
      <span class="inline-flex align-items-center gap-2">
        <input
          type="text"
          [(ngModel)]="selectedSystem!.apiUrl"
          pInputText
          autofocus
          (keyup.enter)="onSave(closeCallback)"/>
        <p-button icon="pi pi-times" aria-label="Cancel" (click)="onClose(closeCallback)" text severity="danger"/>
        <p-button icon="pi pi-check" aria-label="Save" (click)="onSave(closeCallback)" text severity="success"/>
      </span>
          </ng-template>
        </p-inplace>
                  </span>

      </div>


    </p-tabPanel>
    <p-tabPanel *ngIf="!isAasSelected()" header="Headers">
      <app-manage-api-headers [syncSystemId]="selectedSystem!.id!" [allowValues]="false"></app-manage-api-headers>
    </p-tabPanel>
    <p-tabPanel *ngIf="!isAasSelected()" header="Endpoints">

      <app-manage-endpoints [sourceSystemId]="selectedSystem!.id!"></app-manage-endpoints>

    </p-tabPanel>
    <p-tabPanel *ngIf="isAasSelected()" header="AAS Snapshot">
      <div class="p-d-flex p-ai-center p-jc-between" style="margin-bottom: .5rem;">
        <div>
          <strong>Base URL:</strong> {{ selectedSystem?.apiUrl }}
          <span class="ml-3"><strong>AAS ID:</strong> {{ selectedSystem?.aasId || '-' }}</span>
        </div>
        <div>
          <button pButton type="button" label="Refresh Snapshot" class="p-button-text" (click)="discoverAasSnapshot()"
                  [disabled]="aasTreeLoading"></button>
          <button pButton type="button" label="Upload AASX" class="p-button-text" (click)="openAasxUpload()"></button>
          <button pButton type="button" label="+ Submodel" class="p-button-text"
                  (click)="openAasCreateSubmodel()"></button>
        </div>
      </div>
      <button pButton type="button" label="Load Snapshot" (click)="discoverAasSnapshot()"
              [disabled]="aasTreeLoading"></button>
      <span *ngIf="aasTreeLoading" class="ml-2">Loading...</span>
      <div style="display:flex; gap:1rem; align-items:flex-start;">
        <div style="flex: 1 1 65%; min-width: 0;">
          <p-tree [value]="aasTreeNodes" (onNodeExpand)="onAasNodeExpand($event)"
                  (onNodeSelect)="onAasNodeSelect($event)" selectionMode="single">
            <ng-template let-node pTemplate="default">
              <div style="display:flex;align-items:center;gap:.5rem;">
                <span>{{ node.label }}</span>
                <span
                  style="font-size:.75rem;padding:.1rem .4rem;border-radius:999px;border:1px solid var(--surface-border);color:var(--text-color-secondary);">
                    {{ node.data?.type === 'submodel' ? 'Submodel' : (node.data?.modelType || node.data?.raw?.modelType || (node.data?.raw?.valueType ? 'Property' : 'Element')) }}
                  </span>
                <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text"
                        label="Create element" (click)="openAasCreateElement(node.data.id)"></button>
                <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text p-button-danger"
                        label="Delete submodel" (click)="deleteAasSubmodel(node.data.id)"></button>
                <button *ngIf="node.data?.type==='element' && (node.data?.modelType==='SubmodelElementCollection' || node.data?.modelType==='SubmodelElementList' || node.data?.modelType==='Entity')"
                        pButton type="button" class="p-button-text" label="Add child"
                        (click)="openAasCreateElement(node.data.submodelId, node.data.idShortPath)"></button>
                <button *ngIf="node.data?.type==='element'" pButton type="button" class="p-button-text p-button-danger"
                        label="Delete" (click)="deleteAasElement(node.data.submodelId, node.data.idShortPath)"></button>
                <button
                  *ngIf="node.data?.type==='element' && (node.data?.modelType==='Property' || node.data?.raw?.valueType)"
                  pButton type="button" class="p-button-text" label="Set value"
                  (click)="openAasSetValue(node.data.submodelId, node.data)"></button>
              </div>
            </ng-template>
          </p-tree>
        </div>
        <div class="p-card" *ngIf="selectedAasNode && selectedAasNode.data?.type==='element'"
             style="flex: 0 0 35%; padding:1rem;border:1px solid var(--surface-border);border-radius:4px;">
          <div class="p-d-flex p-ai-center p-jc-between">
            <h4 style="margin:0;">Details</h4>
            <span *ngIf="aasSelectedLiveLoading">Loading...</span>
          </div>
          <div *ngIf="aasSelectedLivePanel">
            <div><strong>Label:</strong> {{ aasSelectedLivePanel.label }}</div>
            <div><strong>Type:</strong> {{ aasSelectedLivePanel.type }}</div>
            <div *ngIf="aasSelectedLivePanel.valueType"><strong>valueType:</strong> {{ aasSelectedLivePanel.valueType }}
            </div>
            <div *ngIf="aasSelectedLivePanel.value !== undefined && aasSelectedLivePanel.type!=='SubmodelElementCollection' && aasSelectedLivePanel.type!=='SubmodelElementList' && aasSelectedLivePanel.type!=='MultiLanguageProperty'">
              <strong>value:</strong> {{ (aasSelectedLivePanel.value | json) }}
            </div>
            <div *ngIf="aasSelectedLivePanel.type==='SubmodelElementCollection' || aasSelectedLivePanel.type==='SubmodelElementList'">
              <div><strong>Items:</strong> {{ aasSelectedLivePanel.value?.length || 0 }}</div>
            </div>
            <div *ngIf="aasSelectedLivePanel.type==='MultiLanguageProperty'">
              <div><strong>Values:</strong></div>
              <ul style="margin:.25rem 0 .5rem 1rem;">
                <li *ngFor="let v of aasSelectedLivePanel.value">
                  <span>{{ v?.language || v?.lang || 'â€”' }}:</span>
                  <span> {{ v?.text || v?.value || (v | json) }}</span>
                </li>
              </ul>
            </div>
            <div
              *ngIf="aasSelectedLivePanel.type==='Range' || aasSelectedLivePanel.min !== undefined || aasSelectedLivePanel.max !== undefined">
              <div><strong>min:</strong> {{ aasSelectedLivePanel.min }}</div>
              <div><strong>max:</strong> {{ aasSelectedLivePanel.max }}</div>
            </div>
            <div *ngIf="aasSelectedLivePanel.type==='Operation'">
              <div *ngIf="aasSelectedLivePanel.inputVariables?.length">
                <strong>Inputs:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of aasSelectedLivePanel.inputVariables">{{ v.idShort }} <span
                    *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
              <div *ngIf="aasSelectedLivePanel.inoutputVariables?.length">
                <strong>In/Out:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of aasSelectedLivePanel.inoutputVariables">{{ v.idShort }} <span
                    *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
              <div *ngIf="aasSelectedLivePanel.outputVariables?.length">
                <strong>Outputs:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let v of aasSelectedLivePanel.outputVariables">{{ v.idShort }} <span
                    *ngIf="v.valueType">({{ v.valueType }})</span></li>
                </ul>
              </div>
            </div>
            <div
              *ngIf="aasSelectedLivePanel.type==='RelationshipElement' || aasSelectedLivePanel.type==='AnnotatedRelationshipElement'">
              <div *ngIf="aasSelectedLivePanel.firstRef"><strong>First:</strong> {{ aasSelectedLivePanel.firstRef }}
              </div>
              <div *ngIf="aasSelectedLivePanel.secondRef"><strong>Second:</strong> {{ aasSelectedLivePanel.secondRef }}
              </div>
              <div
                *ngIf="aasSelectedLivePanel.type==='AnnotatedRelationshipElement' && aasSelectedLivePanel.annotations?.length">
                <strong>Annotations:</strong>
                <ul style="margin:.25rem 0 .5rem 1rem;">
                  <li *ngFor="let a of aasSelectedLivePanel.annotations; let i = index">
                    <div><strong>{{ a.idShort || ('Annotation ' + (i + 1)) }}</strong></div>
                    <div *ngIf="a.valueType"><em>valueType:</em> {{ a.valueType }}</div>
                    <div *ngIf="a.value !== undefined"><em>value:</em> {{ (a.value | json) }}</div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </p-tabPanel>
    <p-tabPanel *ngIf="isAasSelected()" header="AAS Configuration">
      <div class="p-grid p-fluid">
        <div class="p-col-12 p-md-6">
          <label>Base URL</label>
          <input pInputText [value]="selectedSystem!.apiUrl" disabled/>
        </div>
        <div class="p-col-12 p-md-6">
          <label>AAS ID</label>
          <input pInputText [(ngModel)]="selectedSystem!.aasId" placeholder="AAS Identifier"/>
        </div>
      </div>
      <div class="p-d-flex p-ai-center" style="margin-top: .75rem; gap: .5rem;">
        <button pButton type="button" label="Test" (click)="aasTest()" [disabled]="aasTestLoading"></button>
        <span *ngIf="aasTestLoading">Testing...</span>
        <small *ngIf="aasTestError" style="color:#d32f2f;">{{ aasTestError }}</small>
      </div>
    </p-tabPanel>
    <p-tabPanel *ngIf="isAasSelected()" header="AAS Actions">
      <div class="p-d-flex p-ai-center" style="gap: .75rem;">
        <button pButton type="button" label="Refresh Snapshot" (click)="discoverAasSnapshot()"
                [disabled]="aasTreeLoading"></button>
      </div>
    </p-tabPanel>
  </p-tabView>

  <p-dialog header="Set Property Value" [(visible)]="showAasValueDialog" [modal]="true" [style]="{width:'35vw'}">
    <div class="p-field">
      <label>Submodel ID</label>
      <input pInputText [value]="aasValueSubmodelId" disabled/>
    </div>
    <div class="p-field">
      <label>Element Path</label>
      <input pInputText [value]="aasValueElementPath" disabled/>
    </div>
    <div class="p-field">
      <label>New Value</label>
      <input pInputText [(ngModel)]="aasValueNew"/>
      <small>valueType: {{ aasValueTypeHint }}</small>
    </div>
    <ng-template pTemplate="footer">
      <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasValueDialog=false"></button>
      <button pButton type="button" label="Save" (click)="aasSetValue()"></button>
    </ng-template>
  </p-dialog>

  <p-dialog header="Create Submodel" [(visible)]="showAasSubmodelDialog" [modal]="true" [style]="{width:'40vw'}">
    <textarea pInputTextarea [(ngModel)]="aasNewSubmodelJson" rows="10" style="width:100%"></textarea>
    <ng-template pTemplate="footer">
      <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasSubmodelDialog=false"></button>
      <button pButton type="button" label="Create" (click)="aasCreateSubmodel()"></button>
    </ng-template>
    <div class="p-mt-2" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <button pButton type="button" class="p-button-text" label="Template: Minimal"
              (click)="setAasSubmodelTemplate('minimal')"></button>
      <button pButton type="button" class="p-button-text" label="Template: With Property"
              (click)="setAasSubmodelTemplate('property')"></button>
      <button pButton type="button" class="p-button-text" label="Template: With Collection"
              (click)="setAasSubmodelTemplate('collection')"></button>
    </div>
  </p-dialog>

  <app-aas-element-dialog
    [(visible)]="showElementDialog"
    [data]="elementDialogData"
    (result)="onElementDialogResult($event)">
  </app-aas-element-dialog>

  <p-dialog header="Upload AASX" [(visible)]="showAasxUpload" [modal]="true" [style]="{width:'35vw'}">
    <div class="p-field">
      <p-fileupload mode="basic" [auto]="false" [showUploadButton]="false" [showCancelButton]="false" accept=".aasx" (onSelect)="onAasxFileSelected($event)"></p-fileupload>
      <small *ngIf="aasxSelectedFile">{{ aasxSelectedFile.name }}</small>
    </div>
    <div *ngIf="aasxPreview?.length" class="p-mt-3">
      <div *ngFor="let sm of aasxPreview" class="p-mb-2">
        <div style="display:flex;align-items:center;gap:.5rem;">
          <p-checkbox binary="true" [ngModel]="getOrInitAasxSelFor(sm).full" (ngModelChange)="toggleAasxSubmodelFull(sm, $event)"></p-checkbox>
          <span class="font-bold">{{ sm.idShort || sm.id }}</span>
          <span style="font-size:.75rem;padding:.1rem .4rem;border:1px solid var(--surface-border);border-radius:999px;color:var(--text-color-secondary);">Submodel</span>
        </div>
      </div>
    </div>
    <div *ngIf="aasxSelectedFile && (!aasxPreview || aasxPreview.length === 0)" class="p-mt-3">
      <small style="color:var(--text-color-secondary);">No submodels found in this AASX file.</small>
    </div>
    <ng-template pTemplate="footer">
      <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasxUpload=false"></button>
      <button pButton type="button" label="Upload" (click)="uploadAasx()" [disabled]="isUploadingAasx || !aasxSelectedFile || !aasxPreview?.length"></button>
    </ng-template>
  </p-dialog>

</div>
