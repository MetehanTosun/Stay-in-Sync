<!--
  -------------------------------------------------------------------------------------------------
  Manage Endpoints Component
  - Display, create, edit, delete, and import endpoints for a source system
  -------------------------------------------------------------------------------------------------
-->
<p-toast></p-toast>
<p-card styleClass="p-p-4">
  <!--
    Section: Import Endpoints
  -->
  <div class="p-mb-3">
    <button
      pButton
      type="button"
      icon="pi pi-cloud-download"
      label="Import Endpoints"
      [disabled]="!apiUrl || importing"
      (click)="importEndpoints()">
    </button>
    <p-progressSpinner *ngIf="importing" styleClass="p-ml-2" strokeWidth="4"></p-progressSpinner>
  </div>
  <!--
    Section: Create New Endpoint Form
  -->
  <form [formGroup]="endpointForm" class="p-fluid p-formgrid p-grid" style="margin: 1.5rem 0; padding: 1rem;">
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="endpointPath">Endpoint Path*</label>
      <input id="endpointPath" pInputText formControlName="endpointPath" />
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="httpRequestType">Method*</label>
      <p-dropdown id="httpRequestType" [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;" *ngIf="endpointForm.get('httpRequestType')?.value === 'POST' || endpointForm.get('httpRequestType')?.value === 'PUT'">
      <label for="requestBodySchema">Request Body Schema (JSON)</label>
      <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
      <div *ngIf="jsonError" class="p-error">{{ jsonError }}</div>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="responseBodySchema">Response Body Schema</label>
      <p-tabView [(activeIndex)]="activeTabIndex" (onChange)="onTabChange($event)">
        <p-tabPanel header="JSON">
          <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="responseBodySchema"></ngx-monaco-editor>
          <div *ngIf="jsonError" class="p-error">{{ jsonError }}</div>
        </p-tabPanel>
        <p-tabPanel header="TypeScript">
          <div *ngIf="isGeneratingTypeScript" class="typescript-loading">
            <p-progressSpinner [style]="{width: '20px', height: '20px'}" strokeWidth="2" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>
            <span class="loading-text">Generating TypeScript interface...</span>
          </div>
          <div *ngIf="!isGeneratingTypeScript && typescriptError" class="typescript-error">
            <div class="error-header">
              <i class="pi pi-exclamation-triangle"></i>
              <span>TypeScript Generation Error</span>
            </div>
            <div class="error-message">{{ typescriptError }}</div>
            <div class="error-actions">
              <button pButton type="button" label="Retry" class="p-button-sm" (click)="loadTypeScriptForMainForm()"></button>
            </div>
          </div>
          <ngx-monaco-editor *ngIf="!isGeneratingTypeScript && !typescriptError" [options]="typescriptEditorOptions" [model]="typescriptModel"></ngx-monaco-editor>
        </p-tabPanel>
      </p-tabView>
    </div>
    <div class="p-col-12" style="margin: 2rem 0;">
      <button pButton type="button" label="Add Endpoint" [disabled]="endpointForm.invalid" (click)="addEndpoint()" 
              [pTooltip]="getAddEndpointTooltip()" tooltipPosition="top"></button>
    </div>
  </form>

  <!--
    Section: Edit Endpoint Dialog
  -->
  <p-dialog header="Edit Endpoint" [(visible)]="editDialog" modal="true" [style]="{ width: '600px' }">
    <form [formGroup]="editForm" class="p-fluid p-formgrid p-grid">
      <div class="p-field p-col-12">
        <label>Endpoint Path*</label>
        <input pInputText formControlName="endpointPath" />
      </div>
      <div class="p-field p-col-12">
        <label>Method*</label>
        <p-dropdown [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
      </div>
      <div class="p-field p-col-12" *ngIf="editForm.get('httpRequestType')?.value === 'POST' || editForm.get('httpRequestType')?.value === 'PUT'">
        <label>Request Body Schema (JSON)</label>
        <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
        <div *ngIf="editJsonError" class="p-error">{{ editJsonError }}</div>
      </div>
      <div class="p-field p-col-12">
        <label>Response Body Schema</label>
        <p-tabView [(activeIndex)]="editActiveTabIndex" (onChange)="onEditTabChange($event)">
          <p-tabPanel header="JSON">
            <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="responseBodySchema"></ngx-monaco-editor>
            <div *ngIf="editJsonError" class="p-error">{{ editJsonError }}</div>
          </p-tabPanel>
          <p-tabPanel header="TypeScript">
            <div *ngIf="isGeneratingEditTypeScript" class="typescript-loading">
              <p-progressSpinner [style]="{width: '20px', height: '20px'}" strokeWidth="2" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>
              <span class="loading-text">Generating TypeScript interface...</span>
            </div>
            <div *ngIf="!isGeneratingEditTypeScript && editTypeScriptError" class="typescript-error">
              <div class="error-header">
                <i class="pi pi-exclamation-triangle"></i>
                <span>TypeScript Generation Error</span>
              </div>
              <div class="error-message">{{ editTypeScriptError }}</div>
              <div class="error-actions">
                <button pButton type="button" label="Retry" class="p-button-sm" (click)="loadTypeScriptForEditForm()"></button>
              </div>
            </div>
            <ngx-monaco-editor *ngIf="!isGeneratingEditTypeScript && !editTypeScriptError" [options]="typescriptEditorOptions" [model]="editTypeScriptModel"></ngx-monaco-editor>
          </p-tabPanel>
        </p-tabView>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-text" (click)="closeEditDialog()"></button>
      <button pButton type="button" label="Save" (click)="saveEdit()" [disabled]="editForm.invalid"></button>
    </ng-template>
  </p-dialog>

  <!--
    Section: Endpoints Data Table
  -->
  <p-table [style]="{ 'margin': '1.5rem 0' }" [value]="endpoints" [loading]="loading" [paginator]="true" [rows]="10">
    <ng-template pTemplate="header">
      <tr>
        <th>Path</th>
        <th>Method</th>
        <th>Request-Body</th>
        <th>Response-Body</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-e>
      <tr>
        <td>{{ e.endpointPath }}</td>
        <td>{{ e.httpRequestType }}</td>
        <td>
          <button *ngIf="e.httpRequestType === 'POST' || e.httpRequestType === 'PUT'" pButton type="button" label="Request Body" (click)="showRequestBodyEditor(e)"></button>
        </td>
        <td>
          <button pButton type="button" label="Response Preview" (click)="showResponsePreviewModal(e)"></button>
        </td>
        <td>
          <!-- Edit endpoint button -->
          <button pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  pTooltip="Edit Endpoint"
                  tooltipPosition="top"
                  (click)="openEditDialog(e)"></button>
          <!-- Manage parameters button -->
          <button pButton
                  type="button"
                  icon="pi pi-cog"
                  class="p-button-info p-button-text p-button-sm"
                  pTooltip="Query-Parameter verwalten"
                  tooltipPosition="top"
                  (click)="selectedEndpoint = e"></button>
          <!-- Delete endpoint button -->
          <button pButton type="button" icon="pi pi-trash" class="p-button-text p-button-sm p-button-danger" (click)="deleteEndpoint(e)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Request Body Editor Overlay (outside of p-card/Dialog) -->
  <div *ngIf="requestBodyEditorEndpoint" class="request-body-editor-overlay" cdkDrag cdkDragRootElement=".request-body-editor-overlay">
    <div class="editor-header" cdkDragHandle>
      <span>Request-Body-Schema f√ºr {{ requestBodyEditorEndpoint.endpointPath }} ({{ requestBodyEditorEndpoint.httpRequestType }})</span>
      <button class="close-btn" (click)="closeRequestBodyEditor()">&#10005;</button>
    </div>
    <ngx-monaco-editor [options]="jsonEditorOptions" [model]="requestBodyEditorModel" (modelChange)="onRequestBodyModelChange($event)"></ngx-monaco-editor>
    <div class="editor-footer">
   
      <span *ngIf="requestBodyEditorError" class="p-error p-ml-3">{{ requestBodyEditorError }}</span>
    </div>
  </div>

  <!-- Response Preview Modal -->
  <app-response-preview-modal
    [(visible)]="responsePreviewModalVisible"
    [endpointId]="selectedResponsePreviewEndpoint?.id"
    [endpointPath]="selectedResponsePreviewEndpoint?.endpointPath || ''"
    [httpMethod]="selectedResponsePreviewEndpoint?.httpRequestType || ''"
    [responseBodySchema]="selectedResponsePreviewEndpoint?.responseBodySchema"
    [responseDts]="selectedResponsePreviewEndpoint?.responseDts"
    (visibleChange)="onResponsePreviewModalVisibleChange($event)">
  </app-response-preview-modal>

  <!-- =================================================================== -->
<!--               Section: Manage Query Parameters                    -->
<!-- =================================================================== -->
<ng-container *ngIf="selectedEndpoint && selectedEndpoint.id != null">
  <app-manage-endpoint-params [endpointId]="selectedEndpoint.id!" [endpointPath]="selectedEndpoint.endpointPath"></app-manage-endpoint-params>
</ng-container>

<!--
  Confirmation dialog for deletion
-->
<app-confirmation-dialog
  [(visible)]="showConfirmationDialog"
  [data]="confirmationData"
  (confirmed)="onConfirmationConfirmed()"
  (cancelled)="onConfirmationCancelled()">
</app-confirmation-dialog>

