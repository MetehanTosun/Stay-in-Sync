<!--
  -------------------------------------------------------------------------------------------------
  Manage Endpoints Component
  - Display, create, edit, delete, and import endpoints for a source system
  -------------------------------------------------------------------------------------------------
-->
<p-card styleClass="p-p-4">
  <!--
    Section: Import Endpoints
  -->
  <div class="p-mb-3">
    <button
      pButton
      type="button"
      icon="pi pi-cloud-download"
      label="Import Endpoints"
      [disabled]="!apiUrl || importing"
      (click)="importEndpoints()">
    </button>
    <p-progressSpinner *ngIf="importing" styleClass="p-ml-2" strokeWidth="4"></p-progressSpinner>
  </div>
  <!--
    Section: Create New Endpoint Form
  -->
  <form [formGroup]="endpointForm" class="p-fluid p-formgrid p-grid" style="margin: 1.5rem 0; padding: 1rem;">
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="endpointPath">Path*</label>
      <input id="endpointPath" pInputText formControlName="endpointPath" />
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="httpRequestType">Method*</label>
      <p-dropdown id="httpRequestType" [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;" *ngIf="endpointForm.get('httpRequestType')?.value === 'POST' || endpointForm.get('httpRequestType')?.value === 'PUT'">
      <label for="requestBodySchema">Request-Body-Schema (JSON)</label>
      <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
      <div *ngIf="jsonError" class="p-error">{{ jsonError }}</div>
    </div>
    <div class="p-col-12" style="margin: 2rem 0;">
      <button pButton type="button" label="Add Endpoint" [disabled]="endpointForm.invalid" (click)="addEndpoint()"></button>
    </div>
  </form>

  <!--
    Section: Edit Endpoint Dialog
  -->
  <p-dialog header="Edit Endpoint" [(visible)]="editDialog" modal="true" [style]="{ width: '400px' }">
    <form [formGroup]="editForm" class="p-fluid p-formgrid p-grid">
      <div class="p-field p-col-12">
        <label>Path</label>
        <input pInputText formControlName="endpointPath" />
      </div>
      <div class="p-field p-col-12">
        <label>Method</label>
        <p-dropdown [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
      </div>
      <div class="p-field p-col-12" *ngIf="editForm.get('httpRequestType')?.value === 'POST' || editForm.get('httpRequestType')?.value === 'PUT'">
        <label>Request-Body-Schema (JSON)</label>
        <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
        <div *ngIf="editJsonError" class="p-error">{{ editJsonError }}</div>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-text" (click)="editDialog=false"></button>
      <button pButton type="button" label="Save" (click)="saveEdit()" [disabled]="editForm.invalid"></button>
    </ng-template>
  </p-dialog>

  <!--
    Section: Endpoints Data Table
  -->
  <p-table [style]="{ 'margin': '1.5rem 0' }" [value]="endpoints" [loading]="loading" [paginator]="true" [rows]="10">
    <ng-template pTemplate="header">
      <tr>
        <th>Path</th>
        <th>Method</th>
        <th>Request-Body-Schema</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-e>
      <tr>
        <td>{{ e.endpointPath }}</td>
        <td>{{ e.httpRequestType }}</td>
        <td>
          <pre *ngIf="e.requestBodySchema">{{ e.requestBodySchema }}</pre>
        </td>
        <td>
          <!-- Button zum Verwalten hinzufügen -->
          <button pButton
                  type="button"
                  icon="pi pi-cog"
                  class="p-button-info p-button-text"
                  pTooltip="Query-Parameter verwalten"
                  tooltipPosition="top"
                  (click)="manage(e)"></button>
          <button pButton type="button" icon="pi pi-trash" class="p-button-text" (click)="deleteEndpoint(e.id!)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- =================================================================== -->
<!--               Section: Manage Query Parameters                    -->
<!-- =================================================================== -->
<div *ngIf="selectedEndpoint" class="p-card p-mt-4 p-p-4">

  <!-- Card Title -->
  <h4 class="p-mb-3">Query-Parameter für: {{ selectedEndpoint.endpointPath }}</h4>

  <!-- Form to Add a New Query Parameter -->
  <form [formGroup]="queryParamForm" (ngSubmit)="addQueryParam()" class="p-fluid p-formgrid p-grid p-mb-4">
    <div class="p-field">
      <label for="paramName">Parameter Name</label>
      <input id="paramName" type="text" pInputText formControlName="paramName" />
      <div *ngIf="queryParamForm.get('paramName')?.touched && queryParamForm.get('paramName')?.hasError('invalidPathParamFormat')" class="p-error">
        Path parameter must be enclosed in braces, e.g. {{ '{' }}paramName{{ '}' }}.
      </div>
    </div>
    <div class="p-field p-col-12 p-md-5">
      <label for="paramType">Typ</label>
      <p-dropdown id="paramType"
                  [options]="paramTypes"
                  optionLabel="label"
                  optionValue="value"
                  formControlName="queryParamType"></p-dropdown>
    </div>
    <div class="p-field p-col-12 p-md-2 p-d-flex p-ai-end">
      <button pButton
              type="submit"
              label="Hinzufügen"
              icon="pi pi-plus"
              [disabled]="queryParamForm.invalid"></button>
    </div>
  </form>

  <!-- Table of Existing Query Parameters -->
  <p-table [value]="queryParams" [loading]="queryParamsLoading" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th style="width: 8rem">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-param>
      <tr>
        <td>{{ param.paramName }}</td>
        <td>{{ param.queryParamType }}</td>
        <td>
          <button pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-danger p-button-text"
                  (click)="deleteQueryParam(param.id!)"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="3">There are no Parameters for this endpoint</td>
      </tr>
    </ng-template>
  </p-table>

</div>

