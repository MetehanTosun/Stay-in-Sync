<p-panel header="Data Sources (ARCs)" [toggleable]="true" styleClass="h-full">
  <p-tabView>
    <!-- Tab 1: All Data Sources -->
    <p-tabPanel header="All Data Sources">
      <ng-container
        *ngTemplateOutlet="
          systemListTemplate;
          context: { systems: allSourceSystems$ | async }
        "
      >
      </ng-container>
    </p-tabPanel>

    <!-- Tab 2: Active in Script -->
    <p-tabPanel header="Active in Script">
      <ng-container
        *ngTemplateOutlet="
          systemListTemplate;
          context: { systems: activeSystems$ | async }
        "
      >
      </ng-container>
      <div
        *ngIf="!(activeSystems$ | async)?.length"
        class="p-3 text-center text-muted"
      >
        <i class="pi pi-info-circle p-mr-2"></i>
        <span>No source systems are currently active in the script.</span>
        <span>Type 'source.system-name.' to load its ARCs.</span>
      </div>
    </p-tabPanel>
  </p-tabView>
</p-panel>

<ng-template #systemListTemplate let-systems="systems">
  <p-accordion
    [multiple]="true"
    *ngIf="systems?.length"
    (onOpen)="onSystemExpand($event.index, systems)"
  >
    <p-accordionTab *ngFor="let system of systems" [header]="system.name">
      <div *ngIf="system.isLoadingEndpoints" class="text-center p-2">
        <p-progressSpinner styleClass="w-2rem h-2rem"></p-progressSpinner>
      </div>

      <div
        *ngIf="!system.isLoadingEndpoints && system.endpoints.length === 0"
        class="p-2 text-muted"
      >
        <span>No endpoints are defined for this source system.</span>
      </div>

      <ng-container *ngIf="system.apiType === 'REST'">
      <div
        *ngFor="let endpoint of system.endpoints"
        class="endpoint-group mb-3"
      >
        <div class="endpoint-header">
          <span class="font-bold"
            >{{ endpoint.httpRequestType }} {{ endpoint.endpointPath }}</span
          >
        </div>

        <p-button
          label="Create New ARC"
          icon="pi pi-plus"
          styleClass="p-button-sm p-button-text"
          (click)="onCreateArc(system, endpoint)"
        ></p-button>

        <div
          *ngIf="(arcsBySystem$ | async)?.get(system.name) as arcsForSystem"
          class="arc-list"
        >
          <div
            *ngFor="let arc of arcsForSystem | filterByType : 'REST' | filterByEndpoint : endpoint.id"
            class="arc-item"
          >
            <span class="ml-2 arc-alias">{{ arc.alias }}</span>
            <div class="arc-actions">

              <!-- EDIT BUTTON -->
              <p-button
                icon="pi pi-pencil"
                styleClass="p-button-rounded p-button-text p-button-sm"
                (click)="onEditArc(system, endpoint, arc)"
                pTooltip="Edit ARC"
              ></p-button>

              <!-- CLONE BUTTON -->
              <p-button
                icon="pi pi-clone"
                styleClass="p-button-rounded p-button-text p-button-sm"
                (click)="onCloneArc(system, endpoint, arc)"
                pTooltip="Clone & Edit"
              ></p-button>

              <!-- DELETE BUTTON -->
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-rounded p-button-text p-button-sm p-button-danger"
                (click)="onDeleteArc(arc)"
                pTooltip="Delete ARC"
              ></p-button>
            </div>
          </div>
        </div>
      </div>
      </ng-container>

      <ng-container *ngIf="system.apiType === 'AAS'">
        <!-- Für AAS listen wir die Submodels als "Pseudo-Endpunkte" auf -->
        <div *ngFor="let submodel of system.submodels" class="endpoint-group mb-3">
          <div class="endpoint-header">
            <i class="pi pi-database mr-2"></i>
            <span class="font-bold">{{ submodel.idShort || submodel.id }}</span>
          </div>
          <p-button label="Create New ARC" icon="pi pi-plus" styleClass="p-button-sm p-button-text" (click)="onCreateAasArc(system, submodel)"></p-button>

          <div *ngIf="(arcsBySystem$ | async)?.get(system.name) as arcsForSystem" class="arc-list">
            <!-- Filtere die ARCs, die zu diesem Submodel gehören -->
            <div *ngFor="let arc of arcsForSystem | filterByType : 'AAS' | filterBySubmodel : submodel.id" class="arc-item">
              <span class="ml-2 arc-alias">{{ arc.alias }}</span>
              <div class="arc-actions">
                <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-text p-button-sm" (click)="onEditAasArc(system, submodel, arc)"></p-button>
                <p-button icon="pi pi-trash" styleClass="p-button-rounded p-button-text p-button-sm p-button-danger" (click)="onDeleteAasArc(arc)"></p-button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

    </p-accordionTab>
  </p-accordion>
</ng-template>
