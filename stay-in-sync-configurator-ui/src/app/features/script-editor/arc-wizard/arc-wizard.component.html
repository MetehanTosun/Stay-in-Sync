<p-dialog
  header="API Request Configuration (ARC)"
  [(visible)]="visible"
  (onHide)="closeDialog()"
  [modal]="true"
  [style]="{ width: '60vw' }"
  [draggable]="false"
  [resizable]="false"
>
  <ng-container *ngIf="context">
    <div class="context-header">
      <span
        class="http-method"
        [ngClass]="context.endpoint.httpRequestType.toLowerCase()"
      >
        {{ context.endpoint.httpRequestType }}
      </span>
      <span class="endpoint-path font-mono">
        {{ context.endpoint.endpointPath }}
      </span>
    </div>

    <p-messages [(value)]="errorMessages" [closable]="true"></p-messages>

    <div *ngIf="isLoadingDefinitions" class="text-center p-4">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Loading parameter definitions...</p>
    </div>

    <form [formGroup]="arcForm" novalidate *ngIf="!isLoadingDefinitions">
      <div class="p-fluid">
        <div class="field">
          <label for="arc-alias">Alias</label>
          <input
            id="arc-alias"
            type="text"
            pInputText
            placeholder="e.g., activeUsers, customerById"
            formControlName="alias"
          />

          <small
            *ngIf="alias?.invalid && (alias?.dirty || alias?.touched)"
            class="p-error block mt-1"
          >
            Alias is a required field.
          </small>
        </div>

        <!-- Path Parameters -->
        <p-fieldset
          legend="Path Parameters"
          *ngIf="pathParamDefinitions.length > 0"
          [formGroupName]="'pathParameters'"
        >
          <div class="p-fluid grid">
            <div
              class="field col-12 md:col-6"
              *ngFor="let param of pathParamDefinitions"
            >
              <label [for]="'path-' + param.name" class="font-bold">
                {{ param.name }}
                <span *ngIf="param.required" class="p-error">*</span>
              </label>
              <input
                [id]="'path-' + param.name"
                type="text"
                pInputText
                [formControlName]="param.name"
                [pTooltip]="param.description"
                tooltipPosition="top"
              />
              <!-- Validation message -->
              <small
                *ngIf="
                  pathParametersGroup.controls[param.name].invalid &&
                  pathParametersGroup.controls[param.name].touched
                "
                class="p-error block mt-1"
              >
                This parameter is required.
              </small>
            </div>
          </div>
        </p-fieldset>

        <!-- Query Parameters -->
        <p-fieldset
          legend="Query Parameters"
          class="mt-3"
          [formArrayName]="'queryParameters'"
        >
          <div
            class="parameter-row grid align-items-center mb-2"
            *ngFor="let param of queryParameters.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Key Input -->
            <div class="field col-5 m-0">
              <label *ngIf="i === 0">Key</label>
              <input
                type="text"
                pInputText
                formControlName="key"
                placeholder="param-key"
              />
            </div>
            <!-- Value Input -->
            <div class="field col-5 m-0">
              <label *ngIf="i === 0">Value</label>
              <input
                type="text"
                pInputText
                formControlName="value"
                placeholder="param-value"
              />
            </div>
            <!-- Actions Column -->
            <div class="col-2 field-actions">
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-danger p-button-text"
                (click)="removeQueryParam(i)"
                pTooltip="Remove Parameter"
                [disabled]="param.get('isRequired')?.value"
              ></p-button>
            </div>
          </div>

          <!-- Message for when there are no query params -->
          <div
            *ngIf="queryParameters.controls.length === 0"
            class="text-center text-color-secondary p-3"
          >
            No query parameters defined. Add one below.
          </div>

          <!-- Add Button -->
          <p-button
            label="Add Query Parameter"
            icon="pi pi-plus"
            styleClass="p-button-sm p-button-outlined mt-2"
            (click)="addCustomQueryParam()"
          ></p-button>
        </p-fieldset>
        
        <p-fieldset
          legend="Headers"
          class="mt-3"
          [formArrayName]="'headerParameters'"
        >
          <div
            class="parameter-row grid align-items-center mb-2"
            *ngFor="let param of headerParameters.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Key Input -->
            <div class="field col-5 m-0">
              <label *ngIf="i === 0">Header Name</label>
              <input
                type="text"
                pInputText
                formControlName="key"
                placeholder="Header-Name"
              />
            </div>
            <!-- Value Input -->
            <div class="field col-5 m-0">
              <label *ngIf="i === 0">Header Value</label>
              <input
                type="text"
                pInputText
                formControlName="value"
                placeholder="header-value"
              />
            </div>
            <!-- Actions Column -->
            <div class="col-2 field-actions">
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-danger p-button-text"
                (click)="removeHeader(i)"
                pTooltip="Remove Header"
              ></p-button>
            </div>
          </div>
          <p-button
            label="Add Header"
            icon="pi pi-plus"
            styleClass="p-button-sm p-button-outlined mt-2"
            (click)="addCustomHeader()"
          ></p-button>
        </p-fieldset>
      </div>
    </form>

    <p-divider></p-divider>

    <!-- Section for testing the API call -->
    <div class="flex justify-content-between align-items-center mb-3">
      <h5 class="m-0">Test & Review Response</h5>
      <p-button
        label="Test Call"
        icon="pi pi-cloud-upload"
        (click)="onTestCall()"
        [loading]="isTesting"
        [disabled]="arcForm.invalid"
      >
      </p-button>
    </div>

    <app-schema-viewer
      [jsonData]="testResult?.responsePayload"
      [dtsCode]="testResult?.generatedDts"
    >
    </app-schema-viewer>
  </ng-container>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      styleClass="p-button-text"
      (click)="closeDialog()"
    >
    </p-button>
    <p-button
      label="Save ARC"
      icon="pi pi-check"
      (click)="onSaveArc()"
      [loading]="isSaving"
      [disabled]="arcForm.invalid || !testResult?.isSuccess"
    >
    </p-button>
  </ng-template>
</p-dialog>
