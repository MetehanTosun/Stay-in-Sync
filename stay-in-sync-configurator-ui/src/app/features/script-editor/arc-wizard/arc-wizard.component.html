<p-dialog
  header="API Request Configuration (ARC)"
  [(visible)]="visible"
  (onHide)="closeDialog()"
  [modal]="true"
  [style]="{ width: '60vw' }"
  [draggable]="false"
  [resizable]="false"
>
  <ng-container *ngIf="context">
    <p-messages [(value)]="errorMessages" [closable]="true"></p-messages>
    <form [formGroup]="arcForm" novalidate *ngIf="!isLoadingDefinitions">
      <div class="p-fluid">
        <div class="field">
          <label for="arc-alias">Alias</label>
          <input
            id="arc-alias"
            type="text"
            pInputText
            placeholder="e.g., activeUsers, customerById"
            formControlName="alias"
          />

          <small
            *ngIf="alias?.invalid && (alias?.dirty || alias?.touched)"
            class="p-error block mt-1"
          >
            Alias is a required field.
          </small>
        </div>

        <!-- Path Parameters -->
        <p-fieldset
          legend="Path Parameters"
          *ngIf="pathParams.length > 0"
          [formGroupName]="'pathParameters'"
        >
          <div class="p-fluid grid">
            <div class="field col-12 md:col-6" *ngFor="let param of pathParams">
              <label [for]="'path-' + param.name" class="font-bold">
                {{ param.name }}
                <span *ngIf="param.required" class="p-error">*</span>
              </label>
              <input
                [id]="'path-' + param.name"
                type="text"
                pInputText
                [formControlName]="param.name"
                [pTooltip]="param.description"
                tooltipPosition="top"
              />
              <!-- Validation message -->
              <small
                *ngIf="
                  pathParametersGroup.controls[param.name].invalid &&
                  pathParametersGroup.controls[param.name].touched
                "
                class="p-error block mt-1"
              >
                This parameter is required.
              </small>
            </div>
          </div>
        </p-fieldset>

        <!-- Query Parameters -->
        <p-fieldset
          legend="Query Parameters"
          *ngIf="queryParams.length > 0"
          class="mt-3"
          [formGroupName]="'queryParameterValues'"
        >
          <div class="p-fluid grid">
            <div
              class="field col-12 md:col-6"
              *ngFor="let param of queryParams"
            >
              <label [for]="'query-' + param.name" class="font-bold">
                {{ param.name }}
                <span *ngIf="param.required" class="p-error">*</span>
              </label>
              <!-- Dropdown for enums/options -->
              <p-dropdown
                *ngIf="param.options && param.options.length > 0"
                [options]="param.options"
                [formControlName]="param.name"
                [showClear]="true"
                placeholder="Select a value"
                [pTooltip]="param.description"
              >
              </p-dropdown>
              <!-- Text input for others -->
              <input
                *ngIf="!param.options || param.options.length > 0"
                type="text"
                pInputText
                [formControlName]="param.name"
                [pTooltip]="param.description"
              />
            </div>
          </div>
        </p-fieldset>
      </div>
    </form>

    <p-divider></p-divider>

    <!-- Section for testing the API call -->
    <div class="flex justify-content-between align-items-center mb-3">
      <h5 class="m-0">Test & Review Response</h5>
      <p-button
        label="Test Call"
        icon="pi pi-cloud-upload"
        (click)="onTestCall()"
        [loading]="isTesting"
        [disabled]="arcForm.invalid"
      >
      </p-button>
    </div>

    <app-schema-viewer
      [jsonData]="testResult?.responsePayload"
      [dtsCode]="testResult?.generatedDts"
    >
    </app-schema-viewer>
  </ng-container>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      styleClass="p-button-text"
      (click)="closeDialog()"
    >
    </p-button>
    <p-button
      label="Save ARC"
      icon="pi pi-check"
      (click)="onSaveArc()"
      [loading]="isSaving"
      [disabled]="arcForm.invalid || !testResult?.isSuccess"
    >
    </p-button>
  </ng-template>
</p-dialog>
