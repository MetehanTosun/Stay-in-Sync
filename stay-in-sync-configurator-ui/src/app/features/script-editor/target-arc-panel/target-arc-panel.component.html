<p-panel styleClass="h-full">
  <!-- NEW: Restructured header for better layout -->
  <ng-template pTemplate="header">
    <div class="custom-panel-header">
      <span class="p-panel-title">Target Directives</span>
      <div class="header-actions">
        <!-- Add a template reference variable #createBtn -->
        <p-button
          label="Create New"
          icon="pi pi-plus"
          (click)="menu.toggle($event)"
          styleClass="p-button-sm"
        ></p-button>

        <p-button
          label="From Library"
          icon="pi pi-book"
          styleClass="p-button-sm p-button-outlined"
          (click)="showLibrary()"
        ></p-button>
        
        <!-- THE FIX: Tell the menu to append its popup to the createBtn -->
        <p-menu 
          #menu 
          [model]="createMenuItems" 
          [popup]="true" 
          appendTo="body" 
          [style]="{ 'z-index': 1101 }"
        ></p-menu>
      </div>
    </div>
  </ng-template>

  <!-- The rest of the template remains the same -->
  <div *ngIf="isLoading" class="text-center p-4">
    <p-progressSpinner styleClass="w-3rem h-3rem"></p-progressSpinner>
  </div>

  <p-accordion *ngIf="!isLoading && activeArcsTree.length > 0" [multiple]="true">
    <p-accordionTab *ngFor="let systemNode of activeArcsTree" [header]="systemNode.data.name">
      <div *ngFor="let arcNode of systemNode.children" class="arc-item">
        <div class="flex align-items-center gap-2">
            <i *ngIf="isRestArc(arcNode.data.arc)" class="pi pi-globe text-primary" pTooltip="REST ARC"></i>
            <i *ngIf="isAasArc(arcNode.data.arc)" class="pi pi-database text-primary" pTooltip="AAS ARC"></i>
            <span>{{ arcNode.data.name }}</span>
        </div>
        <div class="arc-actions">
            <p-button
              icon="pi pi-trash"
              styleClass="p-button-rounded p-button-danger p-button-text"
              (click)="removeArc(arcNode.data.arc)"
              pTooltip="Remove from Transformation"
            ></p-button>
        </div>
      </div>
    </p-accordionTab>
  </p-accordion>
  
  <div *ngIf="!isLoading && activeArcsTree.length === 0" class="text-center p-3 text-color-secondary">
    No directives are configured yet.
  </div>
</p-panel>

<!-- "From Library"-Dialog -->
<p-dialog
  header="Add ARC from Library"
  [(visible)]="displayLibrary"
  [modal]="true"
  [style]="{ width: '60vw' }"
>
  <p-accordion [multiple]="true" (onOpen)="onTabOpen($event)">
    <p-accordionTab
      *ngFor="let system of librarySystems"
      [header]="system.name + ' (' + system.apiType + ')'"
    >
      <div *ngIf="system.isLoading" class="text-center p-2">
        <p-progressSpinner styleClass="w-2rem h-2rem"></p-progressSpinner>
      </div>

      <ul *ngIf="!system.isLoading" class="list-none p-0 m-0">
        <li
          *ngFor="let arc of system.arcs"
          class="flex align-items-center justify-content-between p-2 border-bottom-1 surface-border"
        >
          <span>
            {{ arc.alias }}
            <small *ngIf="isAasArc(arc)" class="text-color-secondary ml-2"
              >({{ arc.submodelIdShort }})</small
            >
          </span>

          <p-button
            [label]="activeArcIds.has(arc.id) ? 'Added' : 'Add'"
            [icon]="activeArcIds.has(arc.id) ? 'pi pi-check' : 'pi pi-plus'"
            [styleClass]="
              'p-button-sm' +
              (activeArcIds.has(arc.id) ? ' p-button-success' : '')
            "
            [disabled]="activeArcIds.has(arc.id)"
            (click)="addArc(arc)"
          >
          </p-button>
        </li>
        <li *ngIf="system.arcs.length === 0" class="p-2 text-center text-muted">
          No ARCs have been created for this Target System yet.
        </li>
      </ul>
    </p-accordionTab>
  </p-accordion>
</p-dialog>

<!-- REST ARC Wizard -->
<app-target-arc-wizard
  *ngIf="isRestWizardVisible"
  [visible]="isRestWizardVisible"
  (visibleChange)="isRestWizardVisible = $event"
  (saveSuccess)="onRestWizardSaveSuccess($event)"
>
</app-target-arc-wizard>

<!-- AAS ARC Wizard -->
<app-target-arc-wizard-aas
  *ngIf="isAasWizardVisible"
  [visible]="isAasWizardVisible"
  (visibleChange)="isAasWizardVisible = $event"
  (saveSuccess)="onAasWizardSaveSuccess($event)"
>
</app-target-arc-wizard-aas>
