<div>
  <p-toast key="endpoints"></p-toast>
  <!-- Table displaying all configured Target Endpoints with actions -->
  <p-table [value]="endpoints" [loading]="loading" [paginator]="true" paginatorPosition="bottom" [rows]="10" [style]="{ 'margin': '1.5rem 0' }">
    <ng-template #caption>
      <div class="flex items-center justify-between">
        <span class="text-xl font-bold">Api Endpoints</span>
        <div class="inline-flex items-center gap-2">
          <button pButton type="button" icon="pi pi-cloud-download" label="Import Endpoints" [disabled]="importing" (click)="importEndpoints()"></button>
          <p-progressSpinner *ngIf="importing" [style]="{width: '20px', height: '20px'}" strokeWidth="2"></p-progressSpinner>
          <button pButton type="button" label="Add Api Endpoint" icon="pi pi-plus" (click)="openCreate()"></button>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Path</th>
        <th>Method</th>
        <th>Request-Body</th>
        <th>Response-Body</th>
        <th>Actions</th>
      </tr>
      <tr>
        <th>
          <p-columnFilter type="text" field="endpointPath" matchMode="contains" placeholder="Search by path"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter field="httpRequestType" matchMode="equals" [showMenu]="false">
            <ng-template #filter let-filter="filterCallback">
              <p-select [options]="httpRequestTypeOptions"
                        (onChange)="filter($event.value)"
                        placeholder="Select Method"
                        [showClear]="true"
                        [style]="{ 'min-width': '12rem' }">
                <ng-template let-option #item>
                  <p>{{ option.label }}</p>
                </ng-template>
              </p-select>
            </ng-template>
          </p-columnFilter>
        </th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td>{{ row.endpointPath }}</td>
        <td>{{ row.httpRequestType }}</td>
        <td>
          <button *ngIf="row.httpRequestType === 'POST' || row.httpRequestType === 'PUT'" pButton type="button" label="Request Body" (click)="openRequestBodyEditor(row)"></button>
        </td>
        <td>
          <button pButton type="button" label="Response Preview" (click)="openResponsePreview(row)"></button>
        </td>
        <td>
          <button pButton icon="pi pi-pencil" class="p-button-text" (click)="openEdit(row)"></button>
          <button pButton
                  type="button"
                  icon="pi pi-cog"
                  class="p-button-info p-button-text"
                  pTooltip="Manage query parameters"
                  tooltipPosition="top"
                  (click)="selectedEndpointForParams = row"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="delete(row)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Dialog for editing an existing Target Endpoint -->
<p-dialog [(visible)]="showDialog" [modal]="true" [style]="{ width: '60rem', height: '50rem' }">
  <ng-template #header>
    <div class="inline-flex items-center justify-center gap-2">
      <span class="font-bold whitespace-nowrap">{{ editing ? 'Edit Endpoint' : 'Add Endpoint' }}</span>
    </div>
  </ng-template>
  <form [formGroup]="form" class="p-fluid p-formgrid p-grid">
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="endpointPath">Endpoint Path*</label>
      <input id="endpointPath" pInputText formControlName="endpointPath">
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="httpRequestType">Method*</label>
      <p-dropdown id="httpRequestType" [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;" *ngIf="form.get('httpRequestType')?.value === 'POST' || form.get('httpRequestType')?.value === 'PUT'">
      <label>Request Body Schema (JSON)</label>
      <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="responseBodySchema">Response-Body-Schema</label>
      <p-tabView (onChange)="onDialogTabChange($event)">
        <p-tabPanel header="JSON">
          <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="responseBodySchema"></ngx-monaco-editor>
        </p-tabPanel>
        <p-tabPanel header="TypeScript">
          <ngx-monaco-editor [options]="typescriptEditorOptions" [model]="typescriptModel"></ngx-monaco-editor>
        </p-tabPanel>
      </p-tabView>
    </div>
  </form>
  <ng-template #footer>
    <p-button label="Cancel" [text]="true" severity="secondary" (click)="showDialog = false"/>
    <p-button label="Save" [outlined]="true" severity="secondary" (click)="save()" [disabled]="form.invalid"
              [pTooltip]="getSaveTooltip()" tooltipPosition="top"/>
  </ng-template>
</p-dialog>

<!-- Section for managing query parameters of the selected endpoint -->
<ng-container *ngIf="selectedEndpointForParams as ep">
  <div class="p-mt-3" style="margin: 1.5rem 0;">
    <app-manage-endpoint-params [endpointId]="ep.id!" [endpointPath]="ep.endpointPath"></app-manage-endpoint-params>
  </div>
</ng-container>

<!-- Draggable overlay editor for modifying request body schema JSON -->
<div *ngIf="requestBodyEditorEndpoint"
     class="request-body-editor-overlay"
     cdkDrag
     cdkDragRootElement=".request-body-editor-overlay">
  <div class="editor-header" cdkDragHandle>
    <span>Request-Body-Schema for {{ requestBodyEditorEndpoint.endpointPath }} ({{ requestBodyEditorEndpoint.httpRequestType }})</span>
    <button class="close-btn" (click)="closeRequestBodyEditor()">&#10005;</button>
  </div>
  <ngx-monaco-editor [options]="jsonEditorOptions"
                     [model]="requestBodyEditorModel"
                     (modelChange)="onRequestBodyModelChange($event)"></ngx-monaco-editor>
  <div class="editor-footer">
    <span *ngIf="requestBodyEditorError" class="p-error p-ml-3">{{ requestBodyEditorError }}</span>
  </div>
</div>

<!-- Modal for previewing target endpoint response body structure -->
<p-toast></p-toast>
<app-target-response-preview-modal
  [(visible)]="responsePreviewDialog"
  [endpointId]="selectedResponsePreviewEndpoint?.id"
  [endpointPath]="selectedResponsePreviewEndpoint?.endpointPath || ''"
  [httpMethod]="selectedResponsePreviewEndpoint?.httpRequestType || ''"
  [responseBodySchema]="selectedResponsePreviewEndpoint?.responseBodySchema"
  [responseDts]="selectedResponsePreviewEndpoint?.responseDts">
</app-target-response-preview-modal>

<!-- Confirmation dialog for endpoint deletion -->
<app-confirmation-dialog
  [(visible)]="showConfirmationDialog"
  [data]="confirmationData"
  (confirmed)="onConfirmationConfirmed()"
  (cancelled)="onConfirmationCancelled()">
</app-confirmation-dialog>

<!-- Import button moved to table caption -->
