<p-card header="Target Endpoints" styleClass="p-p-4">
  <p-toast key="endpoints"></p-toast>
  <div class="p-d-flex p-ai-center p-mb-3" style="gap: .5rem;">
    <button pButton type="button" icon="pi pi-cloud-download" label="Import Endpoints" [disabled]="importing" (click)="importEndpoints()"></button>
    <p-progressSpinner *ngIf="importing" styleClass="p-ml-2" strokeWidth="4"></p-progressSpinner>
  </div>

  <div id="create-endpoint-form"></div>
  <form [formGroup]="form" class="p-fluid p-formgrid p-grid" style="margin: 1.5rem 0; padding: 1rem;">
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="endpointPath">Endpoint Path*</label>
      <input id="endpointPath" pInputText formControlName="endpointPath">
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="httpRequestType">Method*</label>
      <p-dropdown id="httpRequestType" [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;" *ngIf="form.get('httpRequestType')?.value === 'POST' || form.get('httpRequestType')?.value === 'PUT'">
      <label>Request Body Schema (JSON)</label>
      <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label>Response Body Schema</label>
      <p-tabView (onChange)="onDialogTabChange($event)">
        <p-tabPanel header="JSON">
          <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="responseBodySchema"></ngx-monaco-editor>
        </p-tabPanel>
        <p-tabPanel header="TypeScript">
          <ngx-monaco-editor [options]="typescriptEditorOptions" [model]="typescriptModel"></ngx-monaco-editor>
        </p-tabPanel>
      </p-tabView>
    </div>
    <div class="p-col-12" style="margin: 2rem 0;">
      <button pButton type="button" label="Add Endpoint" [disabled]="!form.valid" (click)="addEndpoint()" 
              [pTooltip]="getAddEndpointTooltip()" tooltipPosition="top"></button>
    </div>
  </form>
  <p-table [value]="endpoints" [loading]="loading" [paginator]="true" [rows]="10" [style]="{ 'margin': '1.5rem 0' }">
    <ng-template pTemplate="header">
      <tr>
        <th>Path</th>
        <th>Method</th>
        <th>Request Body</th>
        <th>Response Body</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td>{{ row.endpointPath }}</td>
        <td>{{ row.httpRequestType }}</td>
        <td>
          <button *ngIf="row.httpRequestType === 'POST' || row.httpRequestType === 'PUT'" pButton type="button" label="Request Body" (click)="openRequestBodyEditor(row)"></button>
        </td>
        <td>
          <button pButton type="button" label="Response Preview" (click)="openResponsePreview(row)"></button>
        </td>
        <td>
          <button pButton icon="pi pi-pencil" class="p-button-text" (click)="openEdit(row)"></button>
          <button pButton
                  type="button"
                  icon="pi pi-cog"
                  class="p-button-info p-button-text"
                  pTooltip="Manage query parameters"
                  tooltipPosition="top"
                  (click)="selectedEndpointForParams = row"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="delete(row)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Edit Dialog only -->
<p-dialog [(visible)]="showDialog" [modal]="true" [style]="{width: '60vw', height: '80vh'}" [header]="dialogTitle">
  <form [formGroup]="form" class="p-fluid p-formgrid p-grid" style="margin: 1.5rem 0; padding: 1rem;">
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="endpointPath">Endpoint Path*</label>
      <input id="endpointPath" pInputText formControlName="endpointPath">
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label for="httpRequestType">Method*</label>
      <p-dropdown id="httpRequestType" [options]="httpRequestTypes" formControlName="httpRequestType"></p-dropdown>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;" *ngIf="form.get('httpRequestType')?.value === 'POST' || form.get('httpRequestType')?.value === 'PUT'">
      <label>Request Body Schema (JSON)</label>
      <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="requestBodySchema"></ngx-monaco-editor>
    </div>
    <div class="p-field p-col-12" style="margin-bottom: 1rem;">
      <label>Response Body Schema</label>
      <p-tabView (onChange)="onDialogTabChange($event)">
        <p-tabPanel header="JSON">
          <ngx-monaco-editor [options]="jsonEditorOptions" formControlName="responseBodySchema"></ngx-monaco-editor>
        </p-tabPanel>
        <p-tabPanel header="TypeScript">
          <ngx-monaco-editor [options]="typescriptEditorOptions" [model]="typescriptModel"></ngx-monaco-editor>
        </p-tabPanel>
      </p-tabView>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="showDialog=false"></button>
    <button pButton label="Save" (click)="save()" [disabled]="!form.valid"></button>
  </ng-template>
</p-dialog>

<ng-container *ngIf="selectedEndpointForParams as ep">
  <div class="p-mt-3" style="margin: 1.5rem 0;">
    <app-manage-endpoint-params [endpointId]="ep.id!" [endpointPath]="ep.endpointPath"></app-manage-endpoint-params>
  </div>
</ng-container>

<!-- Request Body Editor Overlay (draggable like Source System) -->
<div *ngIf="requestBodyEditorEndpoint"
     class="request-body-editor-overlay"
     cdkDrag
     cdkDragRootElement=".request-body-editor-overlay">
  <div class="editor-header" cdkDragHandle>
    <span>Request-Body-Schema for {{ requestBodyEditorEndpoint.endpointPath }} ({{ requestBodyEditorEndpoint.httpRequestType }})</span>
    <button class="close-btn" (click)="closeRequestBodyEditor()">&#10005;</button>
  </div>
  <ngx-monaco-editor [options]="jsonEditorOptions"
                     [model]="requestBodyEditorModel"
                     (modelChange)="onRequestBodyModelChange($event)"></ngx-monaco-editor>
  <div class="editor-footer">
    <span *ngIf="requestBodyEditorError" class="p-error p-ml-3">{{ requestBodyEditorError }}</span>
  </div>
</div>

<p-toast></p-toast>
<app-target-response-preview-modal
  [(visible)]="responsePreviewDialog"
  [endpointId]="selectedResponsePreviewEndpoint?.id"
  [endpointPath]="selectedResponsePreviewEndpoint?.endpointPath || ''"
  [httpMethod]="selectedResponsePreviewEndpoint?.httpRequestType || ''"
  [responseBodySchema]="selectedResponsePreviewEndpoint?.responseBodySchema"
  [responseDts]="selectedResponsePreviewEndpoint?.responseDts">
</app-target-response-preview-modal>

<!--
  Confirmation dialog for deletion
-->
<app-confirmation-dialog
  [(visible)]="showConfirmationDialog"
  [data]="confirmationData"
  (confirmed)="onConfirmationConfirmed()"
  (cancelled)="onConfirmationCancelled()">
</app-confirmation-dialog>


