<!-- AAS Management Component for Target Systems -->
<div class="p-d-flex p-ai-center p-jc-between" style="margin-bottom: .5rem;">
  <div>
    <strong>Base URL:</strong> {{ system?.apiUrl }}
    <span class="ml-3"><strong>AAS ID:</strong> {{ getAasId() }}</span>
  </div>
  <div>
    <button pButton type="button" label="Refresh Snapshot" class="p-button-text" (click)="discoverSnapshot()" [disabled]="isLoading"></button>
    <button pButton type="button" label="Upload AASX" class="p-button-text" (click)="openAasxUpload()"></button>
    <button pButton type="button" label="+ Submodel" class="p-button-text" (click)="openCreateSubmodel()"></button>
  </div>
</div>

<button pButton type="button" label="Load Snapshot" (click)="discoverSnapshot()" [disabled]="isLoading"></button>
<span *ngIf="isLoading" class="ml-2">Loading...</span>

<div style="display:flex; gap:1rem; align-items:flex-start;">
  <div style="flex: 1 1 65%; min-width: 0;">
    <p-tree [value]="treeNodes" (onNodeExpand)="onNodeExpand($event)" (onNodeSelect)="onNodeSelect($event)" selectionMode="single" class="custom-tree">
      <ng-template let-node pTemplate="default">
        <div style="display:flex;align-items:center;gap:.5rem;">
          <i [class]="node.expanded ? 'pi pi-folder-open' : 'pi pi-folder'" style="color: var(--primary-color);"></i>
          <span>{{ node.label }}</span>
          <span style="font-size:.75rem;padding:.1rem .4rem;border-radius:999px;border:1px solid var(--surface-border);color:var(--text-color-secondary);">
            {{ getNodeType(node) }}
          </span>
          <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text" label="Create element" (click)="openCreateElement(node.data.id)"></button>
          <button *ngIf="node.data?.type==='element' && canAddChild(node)" pButton type="button" class="p-button-text" label="Add child" (click)="openCreateElement(node.data.submodelId, node.data.idShortPath)"></button>
          <button *ngIf="node.data?.type==='submodel'" pButton type="button" class="p-button-text p-button-danger" label="Delete submodel" (click)="deleteSubmodel(node.data.id)"></button>
          <button *ngIf="node.data?.type==='element'" pButton type="button" class="p-button-text p-button-danger" label="Delete" (click)="deleteElement(node.data.submodelId, node.data.idShortPath)"></button>
          <button *ngIf="node.data?.type==='element' && canSetValue(node)" pButton type="button" class="p-button-text" label="Set value" (click)="openSetValue(node.data.submodelId, node.data)"></button>
        </div>
      </ng-template>
    </p-tree>
  </div>
  <div id="aas-element-details" class="p-card" *ngIf="selectedNode && selectedNode.data?.type==='element'" style="flex: 0 0 35%; padding:1rem;border:1px solid var(--surface-border);border-radius:4px; position: sticky; top: .5rem; align-self: flex-start; max-height: calc(100vh - 1rem); overflow: auto;">
    <div class="p-d-flex p-ai-center p-jc-between">
      <h4 style="margin:0;">Details</h4>
      <span *ngIf="detailsLoading">Loading...</span>
    </div>
    <div *ngIf="selectedLivePanel">
      <div><strong>Label:</strong> {{ selectedLivePanel.label }}</div>
      <div><strong>Type:</strong> {{ selectedLivePanel.type }}</div>
      <div *ngIf="selectedLivePanel.valueType"><strong>valueType:</strong> {{ selectedLivePanel.valueType }}</div>
      <div *ngIf="selectedLivePanel.type==='MultiLanguageProperty' && (selectedLivePanel.value?.length || 0) > 0">
        <strong>values:</strong>
        <div style="margin:.25rem 0 .5rem 0;">
          <div *ngFor="let v of selectedLivePanel.value" style="display:flex;gap:.5rem;align-items:baseline;">
            <span style="font-size:.75rem;padding:.1rem .4rem;border:1px solid var(--surface-border);border-radius:999px;color:var(--text-color-secondary);min-width:2.5rem;text-align:center;">{{ v?.language || '-' }}</span>
            <span>{{ v?.text || '' }}</span>
          </div>
        </div>
      </div>
      <div *ngIf="selectedLivePanel.value !== undefined && selectedLivePanel.type!=='SubmodelElementCollection' && selectedLivePanel.type!=='SubmodelElementList' && selectedLivePanel.type!=='MultiLanguageProperty'">
        <strong>value:</strong> {{ (selectedLivePanel.value | json) }}
      </div>
      <div *ngIf="selectedLivePanel.type==='SubmodelElementCollection'">
        <div><strong>Items:</strong> {{ selectedLivePanel.value?.length || 0 }}</div>
      </div>
      <div *ngIf="selectedLivePanel.type==='SubmodelElementList'">
        <div><strong>Count:</strong> {{ selectedLivePanel.value?.length || 0 }}</div>
      </div>
      <div *ngIf="selectedLivePanel.type==='Range' || selectedLivePanel.min !== undefined || selectedLivePanel.max !== undefined">
        <div><strong>min:</strong> {{ selectedLivePanel.min }}</div>
        <div><strong>max:</strong> {{ selectedLivePanel.max }}</div>
      </div>
      <div *ngIf="selectedLivePanel.type==='Operation'">
        <div *ngIf="selectedLivePanel.inputVariables?.length">
          <strong>Inputs:</strong>
          <ul style="margin:.25rem 0 .5rem 1rem;">
            <li *ngFor="let v of selectedLivePanel.inputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
          </ul>
        </div>
        <div *ngIf="selectedLivePanel.inoutputVariables?.length">
          <strong>In/Out:</strong>
          <ul style="margin:.25rem 0 .5rem 1rem;">
            <li *ngFor="let v of selectedLivePanel.inoutputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
          </ul>
        </div>
        <div *ngIf="selectedLivePanel.outputVariables?.length">
          <strong>Outputs:</strong>
          <ul style="margin:.25rem 0 .5rem 1rem;">
            <li *ngFor="let v of selectedLivePanel.outputVariables">{{ v.idShort }} <span *ngIf="v.valueType">({{ v.valueType }})</span></li>
          </ul>
        </div>
      </div>
      <div *ngIf="selectedLivePanel.type==='RelationshipElement' || selectedLivePanel.type==='AnnotatedRelationshipElement'">
        <div *ngIf="selectedLivePanel.firstRef"><strong>First:</strong> {{ selectedLivePanel.firstRef }}</div>
        <div *ngIf="selectedLivePanel.secondRef"><strong>Second:</strong> {{ selectedLivePanel.secondRef }}</div>
        <div *ngIf="selectedLivePanel.type==='AnnotatedRelationshipElement' && selectedLivePanel.annotations?.length">
          <strong>Annotations:</strong>
          <ul style="margin:.25rem 0 .5rem 1rem;">
            <li *ngFor="let a of selectedLivePanel.annotations; let i = index">
              <div><strong>{{ a.idShort || ('Annotation ' + (i+1)) }}</strong></div>
              <div *ngIf="a.valueType"><em>valueType:</em> {{ a.valueType }}</div>
              <div *ngIf="a.value !== undefined"><em>value:</em> {{ (a.value | json) }}</div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dialog: Create Submodel -->
<p-dialog header="Create Submodel" [(visible)]="showSubmodelDialog" [modal]="true" [style]="{width:'40vw'}">
  <textarea pInputTextarea [(ngModel)]="newSubmodelJson" rows="10" style="width:100%"></textarea>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showSubmodelDialog=false"></button>
    <button pButton type="button" label="Create" (click)="createSubmodel()"></button>
  </ng-template>
  <div class="p-mt-2" style="display:flex;gap:.5rem;flex-wrap:wrap;">
    <button pButton type="button" class="p-button-text" label="Template: Minimal" (click)="setSubmodelTemplate('minimal')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Property" (click)="setSubmodelTemplate('property')"></button>
    <button pButton type="button" class="p-button-text" label="Template: With Collection" (click)="setSubmodelTemplate('collection')"></button>
  </div>
</p-dialog>

<!-- Element Creation Dialog -->
<app-aas-element-dialog
  [(visible)]="showElementDialog"
  [data]="elementDialogData"
  (result)="onElementDialogResult($event)">
</app-aas-element-dialog>

<!-- Dialog: Upload AASX -->
<p-dialog header="Upload AASX" [(visible)]="showAasxUpload" [modal]="true" [style]="{width:'35vw'}">
  <div class="p-field">
    <p-fileupload mode="basic" [auto]="false" [showUploadButton]="false" [showCancelButton]="false" accept=".aasx" (onSelect)="onAasxFileSelected($event)"></p-fileupload>
    <small *ngIf="aasxSelectedFile">{{ aasxSelectedFile.name }}</small>
    <small *ngIf="!aasxSelectedFile" style="color:var(--text-color-secondary);">No AASX file selected. Please choose a file to upload.</small>
  </div>
  <div *ngIf="aasxPreview?.length" class="p-mt-3">
    <div *ngFor="let sm of aasxPreview" class="p-mb-2">
      <div style="display:flex;align-items:center;gap:.5rem;">
        <p-checkbox binary="true" [ngModel]="getOrInitAasxSelFor(sm).full" (ngModelChange)="toggleAasxSubmodelFull(sm, $event)"></p-checkbox>
        <span class="font-bold">{{ sm.idShort || sm.id }}</span>
        <span style="font-size:.75rem;padding:.1rem .4rem;border:1px solid var(--surface-border);border-radius:999px;color:var(--text-color-secondary);">Submodel</span>
      </div>
    </div>
  </div>
  <div *ngIf="aasxSelectedFile && (!aasxPreview || aasxPreview.length === 0)" class="p-mt-3">
    <small style="color:var(--text-color-secondary);">No submodels found in this AASX file.</small>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" label="Cancel" (click)="showAasxUpload=false"></button>
    <button pButton type="button" label="Upload" (click)="uploadAasx()" [disabled]="isUploadingAasx || !aasxSelectedFile || !aasxPreview?.length"></button>
  </ng-template>
</p-dialog>
