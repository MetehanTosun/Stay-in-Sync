<div class="flow-container">
  <div class="header-section">
    <div class="title-section">
      <button class="back-btn" (click)="goBackToOverview()">
        ‚Üê Back to Rules
      </button>
      <h2>Rule Editor - {{ ruleName }}</h2>
    </div>
    <div class="toolbar">
      <button
        class="save-btn"
        [disabled]="isSaving"
        (click)="saveGraph()">
        @if (!isSaving) {
          <span>üíæ Save Graph</span>
        }
        @if (isSaving) {
          <span>‚è≥ Saving...</span>
        }
      </button>

      @if (saveMessage) {
        <div class="save-message" [class.success]="saveMessage.includes('successfully')" [class.error]="saveMessage.includes('Error')">
          {{ saveMessage }}
        </div>
      }
    </div>
  </div>

  <!-- Loading Indicator -->
  @if (isLoadingRule) {
    <div class="loading-indicator">
      <span class="loading-spinner">‚è≥</span>
      <span>Loading transformation rule...</span>
    </div>
  }

  <!-- Error Panel -->
    <div class="error-panel">
      <div class="error-header">
        <div class="error-title">
          <span class="error-icon">‚ö†Ô∏è</span>
          <span>Issues Found ({{ getErrorCount() }})</span>
        </div>
        <div class="error-actions">
          @if (loadingErrors.length > 0) {
            <button class="retry-btn" (click)="retryLoadRule()" title="Retry loading">
              üîÑ Retry
            </button>
          }
          <button class="close-btn" (click)="closeErrorPanel()" title="Close error panel">
            ‚úï
          </button>
        </div>
      </div>

      <div class="error-content">
        <!-- Loading Errors -->
        @if (loadingErrors.length > 0) {
          <div class="error-section">
            <h4 class="error-section-title">
              <span class="section-icon">üîå</span>
              Loading Errors
            </h4>
            @for (error of loadingErrors; track error) {
              <div class="error-item loading-error">
                <span class="error-item-icon">‚ùå</span>
                <span class="error-message">{{ error }}</span>
              </div>
            }
          </div>
        }

        <!-- Validation Errors -->
        @if (validationErrors.length > 0) {
          <div class="error-section">
            <h4 class="error-section-title">
              <span class="section-icon">üîç</span>
              Validation Errors
            </h4>
            @for (error of validationErrors; track error.message) {
              <div class="error-item validation-error">
                <div class="error-details">
                  <div class="error-message">{{ error.message }}</div>
                  <div class="error-meta">
                    <span class="error-type">{{ getErrorTypeDisplayName(error.errorType) }}</span>
                    @if (error.nodeId) {
                      <button class="navigate-btn"
                              (click)="navigateToErrorNode(error.nodeId!)"
                              title="Navigate to problematic node">
                        üìç Go to Node {{ error.nodeId }}
                      </button>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>


  <div class="main-content">
    <div class="compact-palette">
      <button class="palette-button"
              (click)="openNodePaletteMenu($event)"
              title="Add Node">
        <span class="palette-icon">‚ûï</span>
        <span class="palette-label">Add Node</span>
      </button>

      <!-- Node placement status indicator -->
      @if (pendingNodeCreation) {
        <div class="placement-status">
          <span class="status-icon">üìç</span>
          <span class="status-message">
            @if (pendingNodeCreation.operator) {
              Click canvas to place {{ pendingNodeCreation.operator.operatorName }}
            } @else {
              Click canvas to place {{ pendingNodeCreation.type.toLowerCase() }} node
            }
          </span>
          <button class="cancel-placement"
                  (click)="cancelNodePlacement()"
                  title="Cancel node placement">
            ‚úï
          </button>
        </div>
      }
    </div>

    <div class="vflow-wrapper"
         (dragover)="onDragOver($event)"
         (dragleave)="onDragLeave($event)"
         (drop)="onDrop($event)"
         (nodeSelected)="onNodeSelected($event)"
         (nodeContextMenu)="onNodeContextMenuFromEvent($event)">
      <vflow
        [nodes]="nodes"
        [edges]="edges"
        [background]="{ type: 'dots' }"
        (click)="onCanvasClick($event)"
        (onConnect)="createEdge($event)"
        (onEdgesChange.select)="openEdgeContextMenu($event)">

        <!-- sTODO Decide if minimap is worth is (looks bad) -->
        <mini-map [scaleOnHover]="true" />
      </vflow>
    </div>

    <!-- Type Incompatibility Modal -->
    @if (showTypeIncompatibilityModal) {
      <div class="modal-overlay" (click)="closeTypeIncompatibilityModal()">
        <div class="modal-content type-error-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>
              <span class="error-icon">‚ö†Ô∏è</span>
              Type Incompatibility
            </h3>
          </div>

          <div class="modal-body">
            <p class="error-message">{{ typeIncompatibilityMessage }}</p>

            @if (lastAttemptedConnection) {
              <div class="connection-details">
                <div class="connection-info">
                  <div class="type-box source">
                    <span class="type-label">Source:</span>
                    <span class="type-value">{{ lastAttemptedConnection.sourceType }}</span>
                  </div>
                  <div class="arrow">‚Üí</div>
                  <div class="type-box target">
                    <span class="type-label">Target:</span>
                    <span class="type-value">{{ lastAttemptedConnection.targetType }}</span>
                  </div>
                </div>
              </div>
            }

            <p class="help-text">
              These data types are not compatible.
            </p>
          </div>

          <div class="modal-actions">
            <button class="btn-cancel" (click)="closeTypeIncompatibilityModal()">
              ‚úì OK
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Context Menu -->
  @if (showContextMenu && selectedNode) {
    <div class="context-menu"
         [style.left.px]="contextMenuPosition.x"
         [style.top.px]="contextMenuPosition.y"
         (click)="$event.stopPropagation()">

      <!-- Node Type Information -->
      <div class="context-menu-info">
        <div class="node-info">
          <span class="node-name">{{ getNodeData(selectedNode)?.name || 'Unnamed Node' }}</span>

          <!-- Type Information -->
          @if (getNodeData(selectedNode)?.nodeType === 'PROVIDER' || getNodeData(selectedNode)?.nodeType === 'CONSTANT') {
            <!-- Simple output display for Provider and Constant nodes -->
            <div class="simple-type-display">
              <span class="type-label">Output:</span>
              <span class="type-value" [style.color]="getTypeDisplayInfo(getNodeOutputType(selectedNode)).color">
                {{ getTypeDisplayInfo(getNodeOutputType(selectedNode)).icon }} {{ getTypeDisplayInfo(getNodeOutputType(selectedNode)).label }}
              </span>
            </div>
          } @else {
            <!-- Type Flow Visualization for Logic nodes -->
            <div class="type-flow">
              <!-- Input Types (left side) -->
              <div class="input-types-container">
                @if (getNodeAcceptedInputTypes(selectedNode).length > 0) {
                  @for (inputType of getNodeAcceptedInputTypes(selectedNode); track inputType) {
                    <div class="type-node input-type" [style.background-color]="getTypeDisplayInfo(inputType).color">
                      {{ getTypeDisplayInfo(inputType).label }}
                    </div>
                  }
                } @else {
                  <div class="no-input-placeholder">‚àÖ</div>
                }
              </div>

              <!-- Arrow -->
              <div class="flow-arrow">‚Üí</div>

              <!-- Output Type (right side) -->
              <div class="output-type-container">
                <div class="type-node output-type" [style.background-color]="getTypeDisplayInfo(getNodeOutputType(selectedNode)).color">
                  {{ getTypeDisplayInfo(getNodeOutputType(selectedNode)).label }}
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="context-menu-divider"></div>

      <div class="context-menu-item" (click)="startEditingNodeName()">
        <span class="menu-icon">‚úèÔ∏è</span>
        Set Name
      </div>

      <div class="context-menu-divider"></div>

      @if (getNodeData(selectedNode)?.nodeType === 'PROVIDER') {
        <div class="context-menu-item" (click)="startEditingJsonPath()">
          <span class="menu-icon">üìù</span>
          Edit JSON Path
        </div>
      }

      @if (getNodeData(selectedNode)?.nodeType === 'LOGIC') {
        <div class="context-menu-item" (click)="editOperatorType()">
          <span class="menu-icon">‚öôÔ∏è</span>
          Change Operator
        </div>
      }

      @if (getNodeData(selectedNode)?.nodeType === 'CONSTANT') {
        <div class="context-menu-item" (click)="editConstantValue()">
          <span class="menu-icon">üî¢</span>
          Edit Value
        </div>
      }

      <div class="context-menu-divider"></div>

      <div class="context-menu-item danger" (click)="deleteSelectedNode()">
        <span class="menu-icon">üóëÔ∏è</span>
        Delete Node
      </div>
    </div>
  }

  <!-- Edge Context Menu -->
  @if (showEdgeContextMenu && selectedEdge) {
    <div class="context-menu"
         [style.left.px]="edgeContextMenuPosition.x"
         [style.top.px]="edgeContextMenuPosition.y"
         (click)="$event.stopPropagation()">
      <div class="context-menu-item danger" (click)="deleteSelectedEdge()">
        <span class="menu-icon">üóëÔ∏è</span>
        Delete Edge
      </div>
    </div>
  }

  <!-- JSON Path Edit Modal -->
  @if (isEditingJsonPath && selectedNode) {
    <div class="modal-overlay" (click)="cancelEditJsonPath()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Edit JSON Path</h3>
        <div class="form-group">
          <label for="jsonPath">JSON Path:</label>
          <input
            id="jsonPath"
            type="text"
            [(ngModel)]="editingJsonPath"
            class="form-input"
            placeholder="source.example.path"
            #jsonPathInput>
        </div>
        <div class="modal-actions">
          <button class="btn-success" (click)="saveJsonPath()">üíæ Save</button>
          <button class="btn-cancel" (click)="cancelEditJsonPath()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  }

  <!-- Operator Type Edit Modal -->
  @if (isEditingOperator && selectedNode) {
    <div class="modal-overlay" (click)="cancelEditOperator()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Edit Operator Type</h3>
        <div class="form-group">
          <label for="operatorType">Operator Type:</label>
          <select
            id="operatorType"
            [(ngModel)]="editingOperator"
            class="form-input">
            <option value="AND">AND</option>
            <option value="OR">OR</option>
            <option value="NOT">NOT</option>
            <option value="ADD">ADD</option>
            <option value="SUBTRACT">SUBTRACT</option>
            <option value="MULTIPLY">MULTIPLY</option>
            <option value="DIVIDE">DIVIDE</option>
            <option value="EQUALS">EQUALS</option>
            <option value="NOT_EQUALS">NOT_EQUALS</option>
            <option value="GREATER_THAN">GREATER_THAN</option>
            <option value="LESS_THAN">LESS_THAN</option>
            <option value="GREATER_EQUAL">GREATER_EQUAL</option>
            <option value="LESS_EQUAL">LESS_EQUAL</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn-success" (click)="saveOperatorType()">üíæ Save</button>
          <button class="btn-cancel" (click)="cancelEditOperator()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  }

  <!-- Constant Value Edit Modal -->
  @if (isEditingConstantValue && selectedNode) {
    <div class="modal-overlay" (click)="cancelEditConstantValue()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Edit Constant Value</h3>
        <div class="form-group">
          <label for="constantValue">Value:</label>
          <input
            id="constantValue"
            type="text"
            [(ngModel)]="editingConstantValue"
            class="form-input"
            placeholder="Enter value (number, string, or boolean)"
            #constantValueInput>
        </div>
        <div class="modal-actions">
          <button class="btn-success" (click)="saveConstantValue()">üíæ Save</button>
          <button class="btn-cancel" (click)="cancelEditConstantValue()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  }

  <!-- Node Name Edit Modal -->
  @if (isEditingNodeName && selectedNode) {
    <div class="modal-overlay" (click)="cancelEditNodeName()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Set Node Name</h3>
        <div class="form-group">
          <label for="nodeName">Name:</label>
          <input
            id="nodeName"
            type="text"
            [(ngModel)]="editingNodeName"
            class="form-input"
            placeholder="Enter node name"
            #nodeNameInput>
        </div>
        <div class="modal-actions">
          <button class="btn-success" (click)="saveNodeName()">üíæ Save</button>
          <button class="btn-cancel" (click)="cancelEditNodeName()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  }

  <!-- Node Palette Context Menu -->
  @if (showNodePaletteMenu) {
    <div class="context-menu node-palette-menu"
         [style.left.px]="nodePaletteMenuPosition.x"
         [style.top.px]="nodePaletteMenuPosition.y"
         (click)="$event.stopPropagation()">

      <div class="context-menu-item" (click)="selectProviderNode($event)">
        <span class="menu-icon">üì°</span>
        Provider Node
      </div>

      <div class="context-menu-item" (click)="selectLogicNode($event)">
        <span class="menu-icon">‚öôÔ∏è</span>
        Logic Node
      </div>

      <div class="context-menu-item" (click)="selectConstantNode($event)">
        <span class="menu-icon">üî¢</span>
        Constant Node
      </div>
    </div>
  }

  <!-- Logic Group Context Menu -->
  @if (showLogicGroupMenu) {
    <div class="context-menu logic-group-menu"
         [style.left.px]="logicGroupMenuPosition.x"
         [style.top.px]="logicGroupMenuPosition.y"
         (click)="$event.stopPropagation()">

      @for (groupName of Object.keys(logicOperatorGroups); track groupName) {
        <div class="context-menu-item" (click)="selectLogicGroup(groupName, $event)">
          <span class="menu-icon">{{ getGroupDisplayName(groupName).split(' ')[0] }}</span>
          {{ getGroupDisplayName(groupName).split(' ').slice(1).join(' ') }}
        </div>
      }
    </div>
  }

  <!-- Logic Operators Context Menu -->
  @if (showLogicOperatorsMenu && selectedLogicGroup) {
    <div class="context-menu logic-operators-menu"
         [style.left.px]="logicOperatorsMenuPosition.x"
         [style.top.px]="logicOperatorsMenuPosition.y"
         (click)="$event.stopPropagation()">

      <div class="context-menu-header">
        {{ getGroupDisplayName(selectedLogicGroup) }}
      </div>

      @for (operator of getOperatorsForGroup(selectedLogicGroup); track operator.operatorName) {
        <div class="context-menu-item logic-operator-item"
             (click)="selectLogicOperator(operator, $event)"
             [title]="operator.description">
          <div class="operator-details">
            <span class="operator-name">{{ operator.operatorName }}</span>
            <span class="operator-output">‚Üí {{ operator.outputType }}</span>
          </div>
        </div>
      }
    </div>
  }
</div>
