<div class="replay-container">
  <!-- Left pane: Monaco Editor -->
  <section class="left-pane">
    <header class="pane-header">
      <h2>Script (read-only)</h2>
      <p-button (onClick)="onReplayClick()">
        Replay
      </p-button>
    </header>
    <div class="editor-wrapper">
      <ngx-monaco-editor
        [options]="editorOptions"
        [(ngModel)]="scriptDisplay"
        (onInit)="onEditorInit($event)"
      >
      </ngx-monaco-editor>
    </div>
  </section>

  <!-- Right pane: Tabs -->
  <section class="right-pane">
    <p-tabs [ngStyle]="{ height: '100%' }">
      <p-tablist>
        <p-tab value="0">SourceData</p-tab>
        <p-tab value="1">Variables</p-tab>
        <p-tab value="2">Errors</p-tab>
        <p-tab value="3">OutputData</p-tab>
        <p-tab value="4">Logs</p-tab>
      </p-tablist>

      <p-tabpanels>
        <p-tabpanel value="0">
          <div class="tab-content json-viewer-wrapper">
            <ng-container *ngIf="!loading(); else loadingTpl">
              <ng-container *ngIf="!error(); else errorTpl">
                <h3>Source Data</h3>
                <div class="json-scroll-container">
                  <ngx-json-viewer
                    [json]="data()?.transformationResult?.sourceData"
                    [expanded]="false"
                  ></ngx-json-viewer>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </p-tabpanel>


        <p-tabpanel value="1">
          <div class="tab-content">
            <ng-container *ngIf="!loading(); else loadingTpl">
              <ng-container *ngIf="!error(); else errorTpl">
                <h3>Variable Snapshot</h3>
                <ngx-json-viewer
                  [json]="variables"
                  [expanded]="false"
                ></ngx-json-viewer>
              </ng-container>
            </ng-container>
          </div>
        </p-tabpanel>

        <p-tabpanel value="2">
          <div class="tab-content">
            <ng-container *ngIf="!loading(); else loadingTpl">
              <ng-container *ngIf="!error(); else errorTpl">
                <h3>Errors</h3>
                <pre class="terminal">{{ errorInfo || "No errors" }}</pre>
              </ng-container>
            </ng-container>
          </div>
        </p-tabpanel>

        <p-tabpanel value="3">
          <div class="tab-content">
            <ng-container *ngIf="!loading(); else loadingTpl">
              <ng-container *ngIf="!error(); else errorTpl">
                <h3>Output Data</h3>
                <ngx-json-viewer
                  [json]="outputData"
                  [expanded]="false"
                ></ngx-json-viewer>
              </ng-container>
            </ng-container>
          </div>
        </p-tabpanel>

        <p-tabpanel value="4">
          <ng-container *ngIf="!loading(); else loadingTpl">
            <ng-container *ngIf="!error(); else errorTpl">
              <p-table
                [value]="logs"
                [scrollable]="true"
                scrollHeight="flex"
                class="log-table"
                [style.width]="'100%'"
                [style.table-layout]="'fixed'"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th pSortableColumn="timestamp">
                      Timestamp <p-sortIcon field="timestamp"></p-sortIcon>
                    </th>
                    <th>Level</th>
                    <th>Service</th>
                    <th>Message</th>
                  </tr>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>
                      <p-columnFilter
                        type="text"
                        field="message"
                        placeholder="Search by message"
                      ></p-columnFilter>
                    </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-log>
                  <tr>
                    <td class="timestamp">
                      {{ log.timestamp / 1000000 | date : "short" }}
                    </td>
                    <td class="level" [ngClass]="log.level">{{ log.level }}</td>
                    <td
                      style="
                        max-width: 150px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                      "
                    >
                      {{ log.service || "-" }}
                    </td>
                    <td
                      class="message"
                      style="
                        white-space: normal;
                        word-wrap: break-word;
                        max-width: 400px;
                      "
                    >
                      {{ log.message }}
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </ng-container>
          </ng-container>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </section>

  <!-- Templates for Loading & Error -->
  <ng-template #loadingTpl>
    <div class="loading-state">
      <p>Loading...</p>
    </div>
  </ng-template>

  <ng-template #errorTpl>
    <div class="error-state">
      <p class="error">{{ error() }}</p>
    </div>
  </ng-template>
</div>
