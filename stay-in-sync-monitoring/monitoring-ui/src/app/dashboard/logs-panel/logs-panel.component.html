<div class="log-filters">
  <label>
    Start Time:
    <input type="datetime-local" [(ngModel)]="startTime" (change)="onFilterChange()" />
  </label>

  <label>
    End Time:
    <input type="datetime-local" [(ngModel)]="endTime" (change)="onFilterChange()" />
  </label>

  <label>
    Level:
    <p-select
      [options]="levels"
      [(ngModel)]="level"
      (onChange)="onFilterChange()"
      placeholder="All"
      [showClear]="true"
      [filter]="true"
      optionLabel="label"
      optionValue="value">
    </p-select>
  </label>

  <label *ngIf="selectedNodeId && !selectedNodeId.startsWith('POLL')">
    Transformation ID:
    <p-select
      [options]="transformationIds"
      [(ngModel)]="selectedTransformationId"
      (onChange)="onFilterChange()"
      placeholder="All"
      [showClear]="true"
      [filter]="true">
    </p-select>
  </label>

  <label *ngIf="!selectedNodeId || selectedNodeId.startsWith('POLL')">
    Service:
    <p-select
      [options]="services"
      [(ngModel)]="selectedService"
      (onChange)="onServiceChange($event)"
      placeholder="All"
      [showClear]="true"
      [filter]="true">
    </p-select>
  </label>



  <p-button (click)="reloadLogs()">Reload Logs</p-button>
</div>

<!-- Loading & Error -->
<div *ngIf="loading">Loading logs...</div>
<div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

<!-- Log Table -->
<p-table
  *ngIf="!loading && logs.length > 0"
  [value]="logs"
  [scrollable]="true"
  scrollHeight="flex"
  class="log-table"
  [style.width]="'100%'"
  [style.table-layout]="'fixed'"
  [style.height]="'350px'"
>
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="timestamp">
        Timestamp
        <p-sortIcon field="timestamp"></p-sortIcon>
      </th>
      <th>Level</th>
      <th>Service</th>
      <th>Message</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th></th>
      <th>
        <p-columnFilter
          type="text"
          field="message"
          placeholder="Search by message"
          ariaLabel="Filter Message"
        ></p-columnFilter>
      </th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-log>
    <tr>
      <td class="timestamp">{{ (log.timestamp / 1000000) | date: 'short' }}</td>
      <td class="level" [ngClass]="log.level">{{ log.level }}</td>
      <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
        {{ log.service || '-' }}
      </td>
      <td class="message" style="white-space: normal; word-wrap: break-word; max-width: 400px;">
        {{ log.message || buildFallbackMessage(log) }}
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Empty State -->
<div *ngIf="!loading && logs.length === 0">
  <p>No logs found for the selected filters.</p>
</div>
